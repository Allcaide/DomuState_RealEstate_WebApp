<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create New Listing - Estate App</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #3b82f6; /* Main blue */
            --secondary-color: #1e293b; /* Dark background */
            --accent-color: #2563eb; /* Highlight blue */
            --border-radius: 24px;
            --card-bg: #1e293b; /* Card background */
            --text-primary: #e2e8f0; /* Primary text */
            --text-secondary: #94a3b8; /* Secondary text */
        }
    
        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #0f172a; /* Dark background */
            color: var(--text-primary);
        }
    
        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            transition: all 0.3s ease;
        }
    
        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3), 0 0 15px rgba(59, 130, 246, 0.2);
        }
    
        .btn-primary {
            background-color: var(--primary-color);
            border-radius: 12px;
            padding: 12px 24px;
            transition: all 0.2s ease;
        }
    
        .btn-primary:hover {
            background-color: var(--accent-color);
        }
    
        .btn-secondary {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 12px 24px;
            color: var(--text-primary);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.2s ease;
        }
    
        .btn-secondary:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
    
        .form-input {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-primary);
            border-radius: 12px;
            padding: 12px 16px;
            width: 100%;
            transition: all 0.2s ease;
        }
    
        .form-input:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }
    
        .renovation-tier {
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            transition: all 0.2s;
        }
    
        .renovation-tier.selected {
            border-color: var(--primary-color);
            background-color: rgba(59, 130, 246, 0.05);
        }
    
        .renovation-tier.minimum {
            border-left: 4px solid #10b981;
        }
    
        .renovation-tier.low {
            border-left: 4px solid #3b82f6;
        }
    
        .renovation-tier.medium {
            border-left: 4px solid #8b5cf6;
        }
    
        .renovation-tier.high {
            border-left: 4px solid #ef4444;
        }
    
        .bottom-nav {
            background: var(--card-bg);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px 24px 0 0;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
        }
    
        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px;
            color: var(--text-secondary);
        }

        .bottom-nav-item.active {
            color: var(--primary-color);
        }

        select,
        select option {
            background-color: var(--card-bg) !important;
            color: var(--text-primary) !important;
        }

        select:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }

        .feature-locked {
            position: relative; 
        }

        .feature-locked > *:not(.feature-locked-overlay) {
            opacity: 0.3; 
            pointer-events: none; 
        }
        
        .feature-locked-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(30, 41, 59, 0.75); 
            display: flex;
            flex-direction: column; /* Align icon and text vertically */
            justify-content: center;
            align-items: center;
            z-index: 10; 
            border-radius: var(--border-radius); 
            text-align: center;
            color: var(--text-primary);
            pointer-events: auto; 
        }

        .feature-locked-overlay .fa-lock {
            font-size: 2.5rem; 
            margin-bottom: 1rem; /* Space between lock and text */
            color: var(--primary-color);
        }

        .feature-locked-overlay .overlay-text {
            font-size: 1.25rem; 
            font-weight: 600;
        }
    </style>
    <!-- Leaflet JS Map Library -->
    <link href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" rel="stylesheet" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
</head>
<body class="pb-20">
    <!-- Header -->
    <header class="header-gradient text-white pt-6 pb-8 px-6 mb-8 sticky top-0 z-20">
        <div class="container mx-auto">
            <div class="flex justify-between items-center">
                <a href="index.html" class="flex items-center">
                    <i class="fas fa-arrow-left text-white mr-3"></i>
                    <h1 class="text-xl font-bold">Create New Listing</h1>
                </a>
            </div>
        </div>
    </header>

    <!-- Main content - Two-column Layout -->
    <main class="container mx-auto px-4 mb-20">
        <div class="flex flex-col lg:flex-row gap-6">
            <!-- Left side: Form -->
            <div class="lg:w-2/3">
                <form id="create-listing-form" class="space-y-6">
                    <!-- Basic Info Section -->
                    <section class="card p-4">
                        <h2 class="text-lg font-bold mb-4">Basic Information</h2>
                        
                        <div class="mb-4">
                            <label class="block text-gray-400 mb-2" for="title">Property Title</label>
                            <input type="text" id="title" name="title" class="form-input" placeholder="e.g., Modern Apartment in Downtown" required>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-gray-400 mb-2" for="description">Description</label>
                            <textarea id="description" name="description" class="form-input" rows="3" placeholder="Describe your property" required></textarea>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-gray-400 mb-2" for="price">Price (€)</label>
                                <input type="number" id="price" name="price" class="form-input" placeholder="e.g., 450000" required>
                            </div>
                            <div>
                                <label class="block text-gray-400 mb-2" for="propertyType">Property Type</label>
                                <select id="propertyType" name="propertyType" class="form-input" required>
                                    <option value="">Select Property Type</option>
                                    <option value="T1">T1</option>
                                    <option value="T2">T2</option>
                                    <option value="T3">T3</option>
                                    <option value="T4">T4</option>
                                    <option value="T5">T5</option>
                                    <option value="T6">T6+</option>
                                    <option value="Studio">Studio</option>
                                    <option value="Moradia">House</option>
                                    <option value="Terreno">Land</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-4">
                            <div>
                                <label class="block text-gray-400 mb-2" for="bedroom">Bedrooms</label>
                                <input type="number" id="bedroom" name="bedroom" class="form-input" placeholder="e.g., 3" required>
                            </div>
                            <div>
                                <label class="block text-gray-400 mb-2" for="bathroom">Bathrooms</label>
                                <input type="number" id="bathroom" name="bathroom" step="0.5" class="form-input" placeholder="e.g., 2.5" required>
                            </div>
                            <div>
                                <label class="block text-gray-400 mb-2" for="garages">Garages</label>
                                <input type="number" id="garages" name="garages" class="form-input" placeholder="e.g., 1" min="0">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 mt-4">
                            <div>
                                <label class="block text-gray-400 mb-2" for="areaUtil">Usable Area (m²)</label>
                                <input type="number" id="areaUtil" name="area" class="form-input" placeholder="e.g., 120" required>
                                <small class="text-gray-500">Internal usable area of the property</small>
                            </div>
                            <div>
                                <label class="block text-gray-400 mb-2" for="areaBruta">Gross Area (m²)</label>
                                <input type="number" id="areaBruta" name="areaBruta" class="form-input" placeholder="e.g., 150">
                                <small class="text-gray-500">Total area including walls and technical areas</small>
                            </div>
                        </div>
                    </section>
                    
                    <!-- Location Section -->
                    <section class="card p-4">
                        <h2 class="text-lg font-bold mb-4">Location</h2>
                        
                        <div class="mb-4">
                            <label class="block text-white mb-2" for="address">Address</label>
                            <input type="text" id="address" name="address" class="form-input" placeholder="e.g., Av. da Liberdade, 120" required>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-white mb-2" for="city">City</label>
                                <input type="text" id="city" name="city" class="form-input" placeholder="e.g., Lisbon" required>
                            </div>
                            <div>
                                <label class="block text-white mb-2" for="district">District</label>
                                <select id="district" name="district" class="form-input">
                                    <option value="">Select</option>
                                    <option value="Lisboa">Lisbon</option>
                                    <option value="Porto">Porto</option>
                                    <option value="Braga">Braga</option>
                                    <option value="Aveiro">Aveiro</option>
                                    <option value="Setúbal">Setúbal</option>
                                    <option value="Faro">Faro</option>
                                    <option value="Coimbra">Coimbra</option>
                                    <option value="Leiria">Leiria</option>
                                    <option value="Santarém">Santarém</option>
                                    <option value="Viseu">Viseu</option>
                                    <option value="Viana do Castelo">Viana do Castelo</option>
                                    <option value="Vila Real">Vila Real</option>
                                    <option value="Bragança">Bragança</option>
                                    <option value="Castelo Branco">Castelo Branco</option>
                                    <option value="Guarda">Guarda</option>
                                    <option value="Évora">Évora</option>
                                    <option value="Beja">Beja</option>
                                    <option value="Portalegre">Portalegre</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div>
                                <label class="block text-white mb-2" for="postalCode">Postal Code</label>
                                <input type="text" id="postalCode" name="postalCode" class="form-input" placeholder="e.g., 1000-001">
                            </div>
                            <div>
                                <label class="block text-white mb-2" for="parish">Parish</label>
                                <input type="text" id="parish" name="parish" class="form-input" placeholder="e.g., São Domingos de Benfica">
                            </div>
                        </div>
                        
                        <div class="mb-6">
                            <label class="block text-white mb-2">Select the exact location on the map</label>
                            <div id="location-map" style="height: 300px; border-radius: 12px; margin-bottom: 10px;"></div>
                            
                            <div class="flex items-center mt-2 mb-4">
                                <label class="text-white mr-2">Accuracy:</label>
                                <div class="flex items-center space-x-1">
                                    <input type="range" id="radius-slider" min="10" max="500" value="100" class="form-input w-full" style="padding: 0;">
                                    <span id="radius-value" class="text-white">100m</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 mt-4">
                            <div>
                                <label class="block text-gray-400 mb-2" for="latitude">Latitude</label>
                                <input type="text" id="latitude" name="latitude" class="form-input" placeholder="e.g., 38.7223">
                            </div>
                            <div>
                                <label class="block text-gray-400 mb-2" for="longitude">Longitude</label>
                                <input type="text" id="longitude" name="longitude" class="form-input" placeholder="e.g., -9.1393">
                            </div>
                        </div>
                        <div class="flex justify-between mt-4">
                            <button type="button" class="btn-secondary" id="get-location">
                                <i class="fas fa-map-marker-alt mr-2"></i> Get Current Location
                            </button>
                            
                            <button type="button" class="btn-secondary" id="search-location">
                                <i class="fas fa-search mr-2"></i> Search Address
                            </button>
                        </div>
                    </section>
                    
                    <!-- Property Images Section -->
                    <section class="card p-4">
                        <h2 class="text-lg font-bold mb-4">Property Photos</h2>
                        
                        <div class="mb-4">
                            <label class="block text-gray-400 mb-2">Upload Photos (Maximum 10 photos)</label>
                            <div class="border-2 border-dashed border-gray-300 p-4 rounded-lg text-center">
                                <input type="file" id="property-photos" multiple accept="image/*" class="hidden">
                                <label for="property-photos" class="cursor-pointer flex flex-col items-center justify-center">
                                    <i class="fas fa-cloud-upload-alt text-gray-400 text-4xl mb-2"></i>
                                    <span class="text-gray-500">Click to upload photos</span>
                                    <span class="text-gray-400 text-sm mt-1">JPG, PNG or WEBP (max. 5MB each)</span>
                                </label>
                            </div>
                        </div>
                        
                        <div id="property-image-preview" class="flex flex-wrap gap-2 mt-4"></div>
                        
                        <div id="upload-status" class="hidden mt-2 p-2 rounded">
                            <div class="flex items-center">
                                <span id="upload-message" class="flex-grow"></span>
                                <div id="upload-spinner" class="hidden animate-spin rounded-full h-4 w-4 border-t-2 border-blue-500"></div>
                            </div>
                        </div>

                        <input type="hidden" id="uploaded-images" name="images" value="[]">
                    </section>
                    
                    <!-- Renovation Options Section -->
                    <section class="card p-4 feature-locked">
                        <div class="feature-locked-overlay">
                            <i class="fas fa-lock"></i>
                            <p class="overlay-text">Renovation Options - Coming Soon!</p>
                        </div>
                        <h2 class="text-lg font-bold mb-4">Renovation Options</h2>
                        <p class="text-gray-500 mb-4">Add renovation tiers to show potential buyers different possibilities.</p>
                        
                        <!-- Minimum Habitable Tier -->
                        <div class="renovation-tier minimum p-4 mb-4" id="minimum-tier">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="font-bold">Minimum Habitable</h3>
                                <div class="flex items-center">
                                    <span class="text-gray-600 mr-2">Include</span>
                                    <input type="checkbox" id="minimum-enabled" class="tier-checkbox w-5 h-5" disabled>
                                </div>
                            </div>
                            
                            <div class="tier-content hidden">
                                <p class="text-gray-500 mb-3">Basic renovations to make the property habitable.</p>
                                
                                <div class="mb-3">
                                    <label class="block text-gray-400 mb-2" for="minimum-cost">Estimated Cost (€)</label>
                                    <input type="number" id="minimum-cost" name="minimum-cost" class="form-input" placeholder="e.g., 15000" disabled>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="block text-gray-400 mb-2" for="minimum-description">Description</label>
                                    <textarea id="minimum-description" name="minimum-description" class="form-input" rows="2" placeholder="Describe the renovation details..." disabled></textarea>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="block text-gray-400 mb-2">Upload Photos</label>
                                    <div class="border-2 border-dashed border-gray-300 p-3 rounded-lg text-center">
                                        <input type="file" id="minimum-photos" name="minimum-photos" multiple accept="image/*" class="hidden" disabled>
                                        <label for="minimum-photos" class="cursor-pointer flex flex-col items-center justify-center">
                                            <i class="fas fa-images text-gray-400 text-2xl mb-1"></i>
                                            <span class="text-gray-500 text-sm">Upload photos of the minimum renovation</span>
                                        </label>
                                    </div>
                                    <div id="minimum-image-preview" class="flex flex-wrap gap-2 mt-2"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Low Budget Tier -->
                        <div class="renovation-tier low p-4 mb-4" id="low-tier">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="font-bold">Low Budget</h3>
                                <div class="flex items-center">
                                    <span class="text-gray-600 mr-2">Include</span>
                                    <input type="checkbox" id="low-enabled" class="tier-checkbox w-5 h-5" disabled>
                                </div>
                            </div>
                            
                            <div class="tier-content hidden">
                                <p class="text-gray-500 mb-3">Affordable renovations with basic improvements.</p>
                                
                                <div class="mb-3">
                                    <label class="block text-gray-400 mb-2" for="low-cost">Estimated Cost (€)</label>
                                    <input type="number" id="low-cost" name="low-cost" class="form-input" placeholder="e.g., 30000" disabled>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="block text-gray-400 mb-2" for="low-description">Description</label>
                                    <textarea id="low-description" name="low-description" class="form-input" rows="2" placeholder="Describe the renovation details..." disabled></textarea>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="block text-gray-400 mb-2">Upload Photos</label>
                                    <div class="border-2 border-dashed border-gray-300 p-3 rounded-lg text-center">
                                        <input type="file" id="low-photos" name="low-photos" multiple accept="image/*" class="hidden" disabled>
                                        <label for="low-photos" class="cursor-pointer flex flex-col items-center justify-center">
                                            <i class="fas fa-images text-gray-400 text-2xl mb-1"></i>
                                            <span class="text-gray-500 text-sm">Upload photos of the low budget renovation</span>
                                        </label>
                                    </div>
                                    <div id="low-image-preview" class="flex flex-wrap gap-2 mt-2"></div>
                                </div>
                            </div>
                        </div>

                        
                        <!-- Medium Budget Tier -->
                        <div class="renovation-tier medium p-4 mb-4" id="medium-tier">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="font-bold">Medium Budget</h3>
                                <div class="flex items-center">
                                    <span class="text-gray-600 mr-2">Include</span>
                                    <input type="checkbox" id="medium-enabled" class="tier-checkbox w-5 h-5" disabled>
                                </div>
                            </div>
                            
                            <div class="tier-content hidden">
                                <p class="text-gray-500 mb-3">Moderate renovations with significant improvements.</p>
                                
                                <div class="mb-3">
                                    <label class="block text-gray-400 mb-2" for="medium-cost">Estimated Cost (€)</label>
                                    <input type="number" id="medium-cost" name="medium-cost" class="form-input" placeholder="e.g., 60000" disabled>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="block text-gray-400 mb-2" for="medium-description">Description</label>
                                    <textarea id="medium-description" name="medium-description" class="form-input" rows="2" placeholder="Describe the renovation details..." disabled></textarea>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="block text-gray-400 mb-2">Upload Photos</label>
                                    <div class="border-2 border-dashed border-gray-300 p-3 rounded-lg text-center">
                                        <input type="file" id="medium-photos" name="medium-photos" multiple accept="image/*" class="hidden" disabled>
                                        <label for="medium-photos" class="cursor-pointer flex flex-col items-center justify-center">
                                            <i class="fas fa-images text-gray-400 text-2xl mb-1"></i>
                                            <span class="text-gray-500 text-sm">Upload photos of the medium budget renovation</span>
                                        </label>
                                    </div>
                                    <div id="medium-image-preview" class="flex flex-wrap gap-2 mt-2"></div>
                                </div>
                            </div>
                        </div>

                        <!-- High Budget Tier -->
                        <div class="renovation-tier high p-4 mb-4" id="high-tier">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="font-bold">High Budget</h3>
                                <div class="flex items-center">
                                    <span class="text-gray-600 mr-2">Include</span>
                                    <input type="checkbox" id="high-enabled" class="tier-checkbox w-5 h-5" disabled>
                                </div>
                            </div>
                            
                            <div class="tier-content hidden">
                                <p class="text-gray-500 mb-3">Extensive renovations with premium improvements.</p>
                                
                                <div class="mb-3">
                                    <label class="block text-gray-400 mb-2" for="high-cost">Estimated Cost (€)</label>
                                    <input type="number" id="high-cost" name="high-cost" class="form-input" placeholder="e.g., 100000" disabled>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="block text-gray-400 mb-2" for="high-description">Description</label>
                                    <textarea id="high-description" name="high-description" class="form-input" rows="2" placeholder="Describe the renovation details..." disabled></textarea>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="block text-gray-400 mb-2">Upload Photos</label>
                                    <div class="border-2 border-dashed border-gray-300 p-3 rounded-lg text-center">
                                        <input type="file" id="high-photos" name="high-photos" multiple accept="image/*" class="hidden" disabled>
                                        <label for="high-photos" class="cursor-pointer flex flex-col items-center justify-center">
                                            <i class="fas fa-images text-gray-400 text-2xl mb-1"></i>
                                            <span class="text-gray-500 text-sm">Upload photos of the high budget renovation</span>
                                        </label>
                                    </div>
                                    <div id="high-image-preview" class="flex flex-wrap gap-2 mt-2"></div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Add submit button at the end of the form -->
                    <div class="mt-8 flex justify-center">
                        <button type="submit" class="btn-primary text-white font-medium px-8 py-3 text-lg">
                            Publish Listing
                        </button>
                    </div>
                </form>
            </div>

            <!-- Right side: Preview -->
            <div class="lg:w-1/3 sticky top-20 self-start">
                <div class="property-detail-card p-6 bg-gray-800 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold mb-4">Listing Preview</h2>
                    
                    <!-- Property Preview -->
                    <div id="property-preview" class="mb-6">
                        <div class="mb-4 bg-gray-700 rounded-xl overflow-hidden">
                            <div id="preview-image" class="h-48 flex items-center justify-center text-gray-500">
                                <div class="text-center">
                                    <i class="fas fa-image text-4xl mb-2"></i>
                                    <p>Add property photos</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <h3 id="preview-title" class="text-xl font-bold">Property Title</h3>
                            <p id="preview-price" class="text-blue-500 text-xl font-bold">€0.00</p>
                        </div>
                        
                        <div class="mb-4 flex items-center">
                            <i class="fas fa-map-marker-alt text-gray-400 mr-2"></i>
                            <span id="preview-location" class="text-gray-400">Location</span>
                        </div>
                        
                        <div class="flex items-center justify-between text-sm text-gray-400 mb-4">
                            <div>
                                <i class="fas fa-bed mr-1"></i> <span id="preview-bedroom">0</span> bedrooms
                            </div>
                            <div>
                                <i class="fas fa-bath mr-1"></i> <span id="preview-bathroom">0</span> baths
                            </div>
                            <div>
                                <i class="fas fa-ruler-combined mr-1"></i> <span id="preview-area">0</span> m²
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="font-semibold mb-2">Description</h4>
                            <p id="preview-description" class="text-gray-400">
                                Add a description for your property...
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Location Preview with Map -->
                <div class="mt-6 bg-gray-800 rounded-xl shadow-lg">
                    <h4 class="font-semibold p-4">Location on Map</h4>
                    <div id="preview-map" style="height: 300px; border-radius: 0 0 12px 12px;" class="mb-2"></div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // API URL Constants
        const API_URL = 'http://localhost:8800/api';
        const UPLOAD_URL = 'http://localhost:8800/api/listing-images/upload-multiple';
        
        // Wait for document to be fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Document loaded, initializing maps...");
            
            // Create a larger delay to ensure DOM is fully ready
            setTimeout(initializePage, 1500);
            
            function initializePage() {
                // Default location (Lisbon, Portugal)
                const defaultLocation = [38.7223, -9.1393];
                let mainMap, previewMap;
                let mainMarker, previewMarker, circleRadius;
                
                // First check if map containers exist
                const locationMapContainer = document.getElementById('location-map');
                const previewMapContainer = document.getElementById('preview-map');
                
                if (!locationMapContainer) {
                    console.error("Location map container not found!");
                    return;
                }
                
                if (!previewMapContainer) {
                    console.error("Preview map container not found!");
                }
                
                // Initialize the main map
                console.log("Initializing main map...");
                try {
                    mainMap = L.map('location-map').setView(defaultLocation, 13);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                    }).addTo(mainMap);
                    
                    // Add markers and circle to main map
                    mainMarker = L.marker(defaultLocation, {draggable: true}).addTo(mainMap);
                    
                    circleRadius = L.circle(defaultLocation, {
                        radius: 100,
                        fillColor: '#3b82f6',
                        fillOpacity: 0.2,
                        color: '#3b82f6',
                        weight: 1
                    }).addTo(mainMap);
                    
                    // Update initial coordinate inputs
                    updateCoordinateInputs(defaultLocation);
                    
                    // Force main map resize
                    mainMap.invalidateSize();
                    
                    console.log("Main map initialized successfully");
                } catch (error) {
                    console.error("Error initializing main map:", error);
                }
                
                // Initialize the preview map
                if (previewMapContainer) {
                    console.log("Initializing preview map...");
                    try {
                        previewMap = L.map('preview-map').setView(defaultLocation, 13);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                        }).addTo(previewMap);
                        
                        // Add marker to preview map
                        previewMarker = L.marker(defaultLocation).addTo(previewMap);
                        
                        // Force preview map resize
                        previewMap.invalidateSize();
                        
                        console.log("Preview map initialized successfully");
                    } catch (error) {
                        console.error("Error initializing preview map:", error);
                    }
                }
                
                // Setup event listeners once maps are initialized
                setupEventListeners();
                
                // Initialize preview with default values
                updatePreview();
                
                // Helper function to update coordinate inputs
                function updateCoordinateInputs(position) {
                    if (!position) return;
                    
                    const latInput = document.getElementById('latitude');
                    const lngInput = document.getElementById('longitude');
                    
                    if (latInput && lngInput) {
                        latInput.value = position.lat.toFixed(6);
                        lngInput.value = position.lng.toFixed(6);
                    }
                }
                
                // Helper function to update preview map
                function updatePreviewMap(position) {
                    if (!position || !previewMarker || !previewMap) return;
                    
                    try {
                        previewMarker.setLatLng(position);
                        previewMap.setView(position, 13);
                    } catch (error) {
                        console.error("Error updating preview map:", error);
                    }
                }
                
                // Setup all event listeners
                function setupEventListeners() {
                    // Main map click event
                    if (mainMap) {
                        mainMap.on('click', function(e) {
                            const position = e.latlng;
                            if (mainMarker && circleRadius) {
                                mainMarker.setLatLng(position);
                                circleRadius.setLatLng(position);
                                updateCoordinateInputs(position);
                                updatePreviewMap(position);
                            }
                        });
                    }
                    
                    // Main marker drag event
                    if (mainMarker) {
                        mainMarker.on('dragend', function() {
                            const position = mainMarker.getLatLng();
                            if (circleRadius) {
                                circleRadius.setLatLng(position);
                            }
                            updateCoordinateInputs(position);
                            updatePreviewMap(position);
                        });
                    }
                    
                    // Radius slider changes
                    const radiusSlider = document.getElementById('radius-slider');
                    const radiusValue = document.getElementById('radius-value');
                    
                    if (radiusSlider && radiusValue) {
                        radiusSlider.addEventListener('input', function() {
                            const value = this.value;
                            radiusValue.textContent = value + 'm';
                            if (circleRadius) {
                                circleRadius.setRadius(parseInt(value));
                            }
                        });
                    }
                    
                    // Latitude/longitude manual input
                    const latitudeInput = document.getElementById('latitude');
                    const longitudeInput = document.getElementById('longitude');
                    
                    if (latitudeInput && longitudeInput) {
                        latitudeInput.addEventListener('change', updateMapFromCoordinates);
                        longitudeInput.addEventListener('change', updateMapFromCoordinates);
                    }
                    
                    // Get location button
                    const getLocationBtn = document.getElementById('get-location');
                    if (getLocationBtn) {
                        getLocationBtn.addEventListener('click', getCurrentLocation);
                    }
                    
                    // Search location button
                    const searchLocationBtn = document.getElementById('search-location');
                    if (searchLocationBtn) {
                        searchLocationBtn.addEventListener('click', searchLocation);
                    }
                    
                    // Form inputs for preview updates
                    const formInputs = document.querySelectorAll('#create-listing-form input, #create-listing-form textarea, #create-listing-form select');
                    formInputs.forEach(input => {
                        input.addEventListener('input', updatePreview);
                    });
                    
                    // Renovation tier checkboxes
                    const tierCheckboxes = document.querySelectorAll('.tier-checkbox');
                    tierCheckboxes.forEach(checkbox => {
                        checkbox.addEventListener('change', function() {
                            const tierContent = this.closest('.renovation-tier').querySelector('.tier-content');
                            if (tierContent) {
                                if (this.checked) {
                                    tierContent.classList.remove('hidden');
                                } else {
                                    tierContent.classList.add('hidden');
                                }
                            }
                        });
                    });
                    
                    // Image upload handling
                    const propertyPhotosInput = document.getElementById('property-photos');
                    if (propertyPhotosInput) {
                        propertyPhotosInput.addEventListener('change', function(event) {
                            handleImageUpload(event, 'property-image-preview');
                        });
                    }
                }
                
                // Update map from coordinates input
                function updateMapFromCoordinates() {
                    const latInput = document.getElementById('latitude');
                    const lngInput = document.getElementById('longitude');
                    
                    if (!latInput || !lngInput) return;
                    
                    const lat = parseFloat(latInput.value);
                    const lng = parseFloat(lngInput.value);
                    
                    if (!isNaN(lat) && !isNaN(lng) && mainMarker && mainMap) {
                        const position = L.latLng(lat, lng);
                        mainMarker.setLatLng(position);
                        if (circleRadius) {
                            circleRadius.setLatLng(position);
                        }
                        mainMap.setView(position, 13);
                        updatePreviewMap(position);
                    }
                }
                
                // Get current geolocation
                function getCurrentLocation() {
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(function(position) {
                            const lat = position.coords.latitude;
                            const lng = position.coords.longitude;
                            if (mainMarker && mainMap) {
                                const currentPosition = L.latLng(lat, lng);
                                
                                mainMarker.setLatLng(currentPosition);
                                if (circleRadius) {
                                    circleRadius.setLatLng(currentPosition);
                                }
                                mainMap.setView(currentPosition, 15);
                                updateCoordinateInputs(currentPosition);
                                updatePreviewMap(currentPosition);
                            }
                        }, function(error) {
                            alert('Could not get your location: ' + error.message);
                        });
                    } else {
                        alert('Geolocation is not supported by your browser.');
                    }
                }
                
                // Search for location using Nominatim
                function searchLocation() {
                    const addressInput = document.getElementById('address');
                    const cityInput = document.getElementById('city');
                    
                    if (!addressInput || !cityInput) return;
                    
                    const address = addressInput.value || '';
                    const city = cityInput.value || '';
                    const searchQuery = address + ', ' + city;
                    
                    if (!searchQuery.trim() || searchQuery.trim() === ', ') {
                        alert('Please enter an address to search.');
                        return;
                    }
                    
                    console.log("Searching for address:", searchQuery);
                    
                    // Use Nominatim API to search for locations
                    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data && data.length > 0 && mainMarker && mainMap) {
                                const result = data[0];
                                console.log("Found address:", result);
                                
                                const lat = parseFloat(result.lat);
                                const lng = parseFloat(result.lon);
                                const searchPosition = L.latLng(lat, lng);
                                
                                mainMarker.setLatLng(searchPosition);
                                if (circleRadius) {
                                    circleRadius.setLatLng(searchPosition);
                                }
                                mainMap.setView(searchPosition, 15);
                                updateCoordinateInputs(searchPosition);
                                updatePreviewMap(searchPosition);
                            } else {
                                alert('Address not found. Try a more specific address.');
                            }
                        })
                        .catch(error => {
                            console.error("Error searching address:", error);
                            alert('Error searching for address: ' + error.message);
                        });
                }
                
                // Update preview content
                function updatePreview() {
                    // Update title preview
                    const titleInput = document.getElementById('title');
                    const previewTitle = document.getElementById('preview-title');
                    if (titleInput && previewTitle) {
                        previewTitle.textContent = titleInput.value || 'Property Title';
                    }
                    
                    // Update price preview
                    const priceInput = document.getElementById('price');
                    const previewPrice = document.getElementById('preview-price');
                    if (priceInput && previewPrice) {
                        const price = priceInput.value || '0';
                        previewPrice.textContent = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'EUR' }).format(price);
                    }
                    
                    // Update location preview
                    const addressInput = document.getElementById('address');
                    const cityInput = document.getElementById('city');
                    const previewLocation = document.getElementById('preview-location');
                    if (addressInput && cityInput && previewLocation) {
                        const address = addressInput.value || '';
                        const city = cityInput.value || '';
                        let locationText = '';
                        
                        if (address && city) {
                            locationText = `${address}, ${city}`;
                        } else if (address) {
                            locationText = address;
                        } else if (city) {
                            locationText = city;
                        } else {
                            locationText = 'Location';
                        }
                        
                        previewLocation.textContent = locationText;
                    }
                    
                    // Update property details preview
                    const bedroomInput = document.getElementById('bedroom');
                    const previewBedroom = document.getElementById('preview-bedroom');
                    if (bedroomInput && previewBedroom) {
                        previewBedroom.textContent = bedroomInput.value || '0';
                    }
                    
                    const bathroomInput = document.getElementById('bathroom');
                    const previewBathroom = document.getElementById('preview-bathroom');
                    if (bathroomInput && previewBathroom) {
                        previewBathroom.textContent = bathroomInput.value || '0';
                    }
                    
                    const areaInput = document.getElementById('areaUtil');
                    const previewArea = document.getElementById('preview-area');
                    if (areaInput && previewArea) {
                        previewArea.textContent = areaInput.value || '0';
                    }
                    
                    // Update description preview
                    const descriptionInput = document.getElementById('description');
                    const previewDescription = document.getElementById('preview-description');
                    if (descriptionInput && previewDescription) {
                        previewDescription.textContent = descriptionInput.value || 'Add a description for your property...';
                    }
                }
                
                // Handle image uploads and preview
                function handleImageUpload(event, previewElementId) {
                    const files = event.target.files;
                    const previewContainer = document.getElementById(previewElementId);
                    
                    if (!previewContainer || !files.length) return;
                    
                    // Clear previous preview if this is a new upload
                    if (event.target.dataset.resetPreview !== 'false') {
                        previewContainer.innerHTML = '';
                    }
                    
                    for (let i = 0; i < files.length; i++) {
                        const file = files[i];
                        if (!file.type.startsWith('image/')) continue;
                        
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            // Update the image preview
                            const imgPreview = document.createElement('div');
                            imgPreview.classList.add('relative', 'w-24', 'h-24');
                            
                            const img = document.createElement('img');
                            img.src = e.target.result;
                            img.classList.add('w-full', 'h-full', 'object-cover', 'rounded');
                            imgPreview.appendChild(img);
                            
                            // Add a remove button
                            const removeBtn = document.createElement('button');
                            removeBtn.classList.add('absolute', 'top-0', 'right-0', 'bg-red-500', 'text-white', 'rounded-full', 'w-5', 'h-5', 'flex', 'items-center', 'justify-center', 'text-xs');
                            removeBtn.innerHTML = '×';
                            removeBtn.onclick = function() {
                                imgPreview.remove();
                                // If this was the first image, update the main preview with the next image or reset it
                                if (previewElementId === 'property-image-preview') {
                                    updateMainPreviewImage();
                                }
                            };
                            imgPreview.appendChild(removeBtn);
                            
                            // If this is the first image, also update the main preview
                            if (previewElementId === 'property-image-preview' && previewContainer.children.length === 0) {
                                updateMainPreviewImage(e.target.result);
                            }
                            
                            previewContainer.appendChild(imgPreview);
                        };
                        reader.readAsDataURL(file);
                    }
                }
                
                // Update the main preview image
                function updateMainPreviewImage(src) {
                    const previewImg = document.getElementById('preview-image');
                    const previewContainer = document.getElementById('property-image-preview');
                    
                    if (!previewImg) return;
                    
                    if (src) {
                        previewImg.innerHTML = '';
                        previewImg.style.backgroundImage = `url(${src})`;
                        previewImg.style.backgroundSize = 'cover';
                        previewImg.style.backgroundPosition = 'center';
                    } else if (previewContainer && previewContainer.children.length > 0) {
                        // If there are other images, use the first one
                        const firstImg = previewContainer.children[0].querySelector('img');
                        if (firstImg) {
                            previewImg.style.backgroundImage = `url(${firstImg.src})`;
                            previewImg.style.backgroundSize = 'cover';
                            previewImg.style.backgroundPosition = 'center';
                        } else {
                            // Reset to default
                            previewImg.style.backgroundImage = 'none';
                            previewImg.innerHTML = `
                                <div class="text-center">
                                    <i class="fas fa-image text-4xl mb-2"></i>
                                    <p>Add property photos</p>
                                </div>
                            `;
                        }
                    } else {
                        // Reset to default
                        previewImg.style.backgroundImage = 'none';
                        previewImg.innerHTML = `
                            <div class="text-center">
                                <i class="fas fa-image text-4xl mb-2"></i>
                                <p>Add property photos</p>
                            </div>
                        `;
                    }
                }
                // Form submission handling
                const createListingForm = document.getElementById('create-listing-form');
                if (createListingForm) {
                    createListingForm.addEventListener('submit', async function(e) {
                        e.preventDefault();
                        
                        // Check if the user is logged in
                        const token = localStorage.getItem('token');
                        if (!token) {
                            alert('You need to be logged in to publish a listing.');
                            window.location.href = 'login.html';
                            return;
                        }
                        
                        // Show loading state
                        const submitBtn = createListingForm.querySelector('button[type="submit"]');
                        const originalBtnText = submitBtn.innerHTML;
                        submitBtn.disabled = true;
                        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Submitting...';
                        
                        try {
                            // First upload the images to Storj
                            const imageUrls = await uploadImages();
                            
                            // Then create the property listing with the image URLs
                            const formData = new FormData(createListingForm);
                            const listingData = Object.fromEntries(formData.entries());
                            
                            // Add the image URLs to the listing data
                            listingData.images = imageUrls;
                            
                            // Format special fields to match schema types
                            if (listingData.price) listingData.price = parseInt(listingData.price);
                            if (listingData.bedroom) listingData.bedroom = parseInt(listingData.bedroom);
                            if (listingData.bathroom) listingData.bathroom = parseInt(listingData.bathroom);
                            if (listingData.area) listingData.area = parseInt(listingData.area);
                            
                            // Keep only fields defined in the Prisma schema
                            const cleanedData = {
                                title: listingData.title,
                                description: listingData.description,
                                price: listingData.price,
                                images: listingData.images,
                                address: listingData.address,
                                city: listingData.city,
                                bedroom: listingData.bedroom,
                                bathroom: listingData.bathroom,
                                latitude: String(listingData.latitude || ""),
                                longitude: String(listingData.longitude || ""),
                                area: listingData.area
                            };
                            
                            console.log('Cleaned listing data:', cleanedData);
                            
                            // Handle renovation tiers if enabled
                            const renovationTiers = [];
                            
                            if (document.getElementById('minimum-enabled').checked) {
                                renovationTiers.push({
                                    type: 'minimum',
                                    cost: document.getElementById('minimum-cost').value,
                                    description: document.getElementById('minimum-description').value
                                });
                            }
                            
                            if (document.getElementById('low-enabled').checked) {
                                renovationTiers.push({
                                    type: 'low',
                                    cost: document.getElementById('low-cost').value,
                                    description: document.getElementById('low-description').value
                                });
                            }
                            
                            if (document.getElementById('medium-enabled').checked) {
                                renovationTiers.push({
                                    type: 'medium',
                                    cost: document.getElementById('medium-cost').value,
                                    description: document.getElementById('medium-description').value
                                });
                            }
                            
                            if (document.getElementById('high-enabled').checked) {
                                renovationTiers.push({
                                    type: 'high',
                                    cost: document.getElementById('high-cost').value,
                                    description: document.getElementById('high-description').value
                                });
                            }
                            
                            if (renovationTiers.length > 0) {
                                listingData.renovationTiers = JSON.stringify(renovationTiers);
                            }
                            
                            console.log('Sending listing data:', listingData);
                            // Create the listing
                            const response = await fetch(`${API_URL}/posts`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${token}`
                                },
                                body: JSON.stringify(cleanedData)
                            });
                            
                            console.log('Response status:', response.status);
                            
                            
                            // Check if response type is HTML (error page)
                            const contentType = response.headers.get("content-type");
                            if (contentType && contentType.includes("text/html")) {
                                throw new Error("Server returned HTML instead of JSON. This usually indicates a server-side error.");
                            }
                            
                            if (response.status === 404) {
                                throw new Error('API not found. Please check if the server is running.');
                            }
                            
                            if (response.status === 401) {
                                localStorage.removeItem('token');
                                alert('Session expired. Please login again.');
                                window.location.href = 'login.html';
                                return;
                            }
                            
                            if (!response.ok) {
                                const errorData = await response.json();
                                throw new Error(errorData.message || 'Error creating listing');
                            }
                            
                            const responseData = await response.json();
                            
                            // Success! Redirect to the new listing
                            alert('Listing created successfully!');
                            window.location.href = `property.html?id=${responseData.postId}`;
                            
                        } catch (error) {
                            console.error('Error creating listing:', error);
                            
                            // Provide more specific error message based on error type
                            let errorMessage = `Error creating listing: ${error.message}`;
                            
                            if (error.message.includes("<!DOCTYPE")) {
                                errorMessage = "Server returned HTML instead of JSON. This usually indicates a server-side error.";
                            } else if (error.message.includes("Failed to fetch")) {
                                errorMessage = "Could not connect to the server. Check your internet connection or if the server is running.";
                            } else if (error.message.includes("NetworkError")) {
                                errorMessage = "Network error. Check your internet connection.";
                            }
                            
                            alert(errorMessage);
                            
                            // Reset button state
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = originalBtnText;
                        }
                    });
                }
                
                // Upload images to the local API server
                async function uploadImages() {
                    const fileInput = document.getElementById('property-photos');
                    if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
                        console.log('No images to upload');
                        return [];
                    }

                    if (fileInput.files.length > 20) {
                        throw new Error('Maximum of 20 images allowed');
                    }
                    
                    // Show upload status
                    const uploadStatus = document.getElementById('upload-status');
                    const uploadMessage = document.getElementById('upload-message');
                    const uploadSpinner = document.getElementById('upload-spinner');
                    
                    if (uploadStatus) uploadStatus.classList.remove('hidden', 'bg-red-100', 'text-red-700');
                    if (uploadStatus) uploadStatus.classList.add('bg-blue-100', 'text-blue-700');
                    if (uploadMessage) uploadMessage.textContent = 'Uploading images...';
                    if (uploadSpinner) uploadSpinner.classList.remove('hidden');
                    
                    try {
                        const formData = new FormData();
                        const listingCode = Date.now().toString(36);
                        
                        // Validate each file before adding to formData
                        for (let i = 0; i < fileInput.files.length; i++) {
                            const file = fileInput.files[i];
                            
                            // Check file type
                            if (!file.type.match(/^image\/(jpeg|png|webp)$/)) {
                                throw new Error(`File ${file.name} is not a valid image type (JPEG, PNG, WEBP).`);
                            }
                            
                            // Check file size (5MB limit)
                            if (file.size > 5 * 1024 * 1024) {
                                throw new Error(`File ${file.name} exceeds the 5MB size limit.`);
                            }
                            
                            formData.append('images', file);
                        }
                        
                        formData.append('listingCode', listingCode);
                        
                        // Get auth token
                        const token = localStorage.getItem('token');
                        if (!token) {
                            throw new Error('Authentication required');
                        }
                        
                        console.log('Uploading images...');
                        const response = await fetch(`${API_URL}/listing-images/upload-multiple`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`
                            },
                            body: formData
                        });
                        
                        // Check if response type is HTML (error page)
                        const contentType = response.headers.get("content-type");
                        if (contentType && contentType.includes("text/html")) {
                            throw new Error("Server returned HTML instead of JSON during image upload.");
                        }
                        
                        if (!response.ok) {
                            let errorMessage = 'Failed to upload images';
                            try {
                                const errorData = await response.json();
                                errorMessage = errorData.error || errorData.message || errorMessage;
                            } catch (e) {
                                console.error('Could not parse error response:', e);
                            }
                            throw new Error(errorMessage);
                        }
                        
                        const data = await response.json();
                        console.log('Upload successful:', data);
                        
                        // Update status to success
                        if (uploadStatus) uploadStatus.classList.remove('bg-blue-100', 'text-blue-700');
                        if (uploadStatus) uploadStatus.classList.add('bg-green-100', 'text-green-700');
                        if (uploadMessage) uploadMessage.textContent = 'Images uploaded successfully!';
                        if (uploadSpinner) uploadSpinner.classList.add('hidden');
                        
                        if (data && Array.isArray(data.imageUrls)) {
                            return data.imageUrls;
                        } else {
                            console.warn('Invalid image URLs format returned:', data);
                            return [];
                        }
                    } catch (error) {
                        console.error('Error uploading images:', error);
                        
                        // Update status to error
                        if (uploadStatus) uploadStatus.classList.remove('bg-blue-100', 'text-blue-700');
                        if (uploadStatus) uploadStatus.classList.add('bg-red-100', 'text-red-700');
                        if (uploadMessage) uploadMessage.textContent = `Error uploading images: ${error.message}`;
                        if (uploadSpinner) uploadSpinner.classList.add('hidden');
                        
                        throw error;
                    }
                }
            }
        });
    </script>
    
    <!-- Custom image upload script for the new naming convention -->
    <script src="/js/listing-image-upload.js"></script>
</body>
</html>
``` 