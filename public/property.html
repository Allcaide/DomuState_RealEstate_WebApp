<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Property Details - Estate App</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" rel="stylesheet" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
    <style>/*All the final alinments design/visual final review were performed with help of various AI to find various problems throughout the development */
        :root {
            --primary-color: #3b82f6;
            --secondary-color: #1e293b;
            --accent-color: #2563eb;
            --border-radius: 24px;
            --card-bg: #1e293b;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
        }
        
        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #0f172a;
            color: var(--text-primary);
        }
        
        .header-gradient {
            background: linear-gradient(90deg, #1e40af 0%, #1e3a8a 100%);
            border-radius: 0 0 30px 30px;
        }
        
        .property-detail-card {
            background: var(--card-bg);
            border-radius: 24px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        
        .property-image {
            height: 400px;
            object-fit: cover;
        }
        
        .feature-badge {
            background-color: #0f172a;
            border-radius: 12px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
        }
        
        .nav-link {
            position: relative;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
            transition: all 0.15s ease;
            padding: 8px 0;
        }
        
        .nav-link:hover {
            color: #ffffff;
            transform: translateY(-2px);
        }
        
        .nav-link.active {
            color: #ffffff;
        }
        
        .nav-link.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background-color: #ffffff;
            border-radius: 10px;
        }
        
        .heart-icon {
            background-color: rgba(15, 23, 42, 0.9);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            color: #e2e8f0;
        }
        
        .heart-icon:hover, .heart-icon.active {
            color: #f43f5e;
        }
        
        .price-tag {
            color: var(--primary-color);
            font-weight: 700;
            font-size: 24px;
        }
        
        .section-heading {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        
        .details-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }
        
        @media (min-width: 768px) {
            .details-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        .detail-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            background-color: rgba(30, 41, 59, 0.7);
            border-radius: 12px;
        }
        
        .detail-item i {
            color: var(--primary-color);
        }
        
        .feature-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 0.5rem;
        }
        
        .feature-available {
            background-color: rgba(74, 222, 128, 0.2);
            color: #4ade80;
        }
        
        .feature-unavailable {
            background-color: rgba(248, 113, 113, 0.2);
            color: #f87171;
        }
        
        .image-gallery {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: 200px 200px;
            gap: 0.5rem;
            margin-bottom: 2rem;
        }
        
        .gallery-main {
            grid-column: span 2;
            grid-row: span 2;
            height: 100%;
        }
        
        .gallery-item {
            overflow: hidden;
            border-radius: 12px;
        }
        
        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }
        
        .gallery-item:hover img {
            transform: scale(1.05);
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-radius: 12px;
            padding: 12px 24px;
            transition: all 0.15s ease;
        }
        
        .btn-primary:hover {
            background-color: var(--accent-color);
        }
        
        .btn-outline {
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            border-radius: 12px;
            padding: 12px 24px;
            transition: all 0.15s ease;
        }
        
        .btn-outline:hover {
            background-color: rgba(59, 130, 246, 0.1);
        }
        
        .auth-links {
            font-weight: 500;
        }
        
        .auth-btn {
            background: transparent;
            color: var(--text-primary);
            border-radius: 12px;
            padding: 8px 16px;
            font-weight: 600;
            border: 1px solid transparent;
            transition: all 0.15s ease;
        }
        
        .auth-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        
        .mobile-nav {
            background-color: #0f172a;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body>
    <!-- Header with gradient background -->
    <header class="header-gradient text-white pt-6 pb-8 px-6 mb-8">
        <div class="container mx-auto">
            <div class="flex justify-between items-center mb-8">
                <a href="/index.html" class="text-2xl font-bold">DomuState</a>
                
                <!-- Navigation Links - Desktop -->
                <nav class="hidden md:flex space-x-10">
                    <a href="/index.html" class="nav-link active">Home</a>
                    <a href="/favorites.html" class="nav-link">Favourites</a>
                    <a href="/new_listing.html" class="nav-link">Sell</a>
                    <!-- Locked feature with padlock icon -->
                    <a href="#" class="nav-link locked-feature" style="pointer-events: none">
                        <span class="flex items-center gap-2 opacity-50">
                            Renovate
                            <i class="fas fa-lock text-sm"></i>
                        </span>
                    </a>
                </nav>
                
                <!-- Placeholder para manter o grid balanceado -->
                <div class="w-[100px]"></div>
                
                <!-- Auth Links - Desktop -->
                <div class="hidden md:flex items-center space-x-4 auth-links" id="authLinks">
                    <a href="/login.html" class="auth-btn">Sign in</a>
                    <span class="text-white opacity-50">|</span>
                    <a href="/register.html" class="auth-btn">Sign up</a>
                </div>
                
                <!-- User Info - Desktop -->
                <div class="hidden md:flex items-center space-x-4 auth-linkslogout" id="userInfo" style="display: none;">
                    <i class="fas fa-user text-white"></i>
                    <a href="/user-profile.html" id="username" class="text-white transition-all duration-150 hover:text-blue-200 hover:-translate-y-0.5"></a>
                    <button id="logoutBtn" class="text-white transition-all duration-150 hover:text-blue-200 hover:-translate-y-0.5">Logout</button>
                </div>
                
                <!-- Mobile menu button -->
                <button class="md:hidden p-2 rounded-full bg-white bg-opacity-10 hover:bg-opacity-20 transition-all duration-150">
                    <i class="fas fa-bars text-white"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Main content -->
    <main class="container mx-auto px-6 pb-24">
        <!-- Property Header -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
            <div>
                <a href="/index.html" class="text-blue-400 mb-2 inline-block">
                    <i class="fas fa-arrow-left mr-2"></i> Back to listings
                </a>
                <h1 id="propertyTitle" class="text-2xl md:text-3xl font-bold">Loading property details...</h1>
                <p id="propertyLocation" class="text-gray-400 mt-1">
                    <i class="fas fa-map-marker-alt mr-1"></i> 
                </p>
            </div>
            <div class="mt-4 md:mt-0">
                <button id="favoriteBtn" class="heart-icon p-3 rounded-full mr-3">
                    <i class="fas fa-heart"></i>
                </button>
                <span id="propertyPrice" class="price-tag text-2xl"></span>
            </div>
        </div>

        <!-- Property Images -->
        <div id="imageGallery" class="mb-8">
            <div class="bg-gray-700 rounded-xl h-96 flex items-center justify-center">
                <p class="text-gray-400">Loading images...</p>
            </div>
        </div>

        <!-- Property Details -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12">
            <!-- Main Details -->
            <div class="md:col-span-2">
                <div class="property-detail-card p-6 mb-8">
                    <h2 class="section-heading">Property Details</h2>
                    <div class="details-grid">
                        <div class="detail-item">
                            <i class="fas fa-bed text-lg"></i>
                            <div>
                                <div class="text-sm text-gray-400">Bedrooms</div>
                                <div id="bedrooms" class="font-semibold">-</div>
                            </div>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-bath text-lg"></i>
                            <div>
                                <div class="text-sm text-gray-400">Bathrooms</div>
                                <div id="bathrooms" class="font-semibold">-</div>
                            </div>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-ruler-combined text-lg"></i>
                            <div>
                                <div class="text-sm text-gray-400">Area</div>
                                <div id="area" class="font-semibold">-</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="property-detail-card p-6 mb-8">
                    <h2 class="section-heading">Description</h2>
                    <p id="propertyDescription" class="text-gray-300 leading-relaxed">Loading property description...</p>
                </div>

                <div class="property-detail-card p-6">
                    <h2 class="section-heading">Amenities</h2>
                    <div class="relative mt-2"> <!-- Wrapper for amenities list and overlay -->
                        <div id="amenitiesContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4 opacity-30 min-h-[120px] pointer-events-none">
                            <p class="text-gray-400 col-span-full text-center py-8"></p> <!-- Initial loading message -->
                        </div>
                        <!-- The Lock Overlay -->
                        <div class="absolute inset-0 flex flex-col items-center justify-center bg-slate-800/75 rounded-xl z-20 backdrop-blur-sm">
                            <i class="fas fa-lock text-blue-500 text-4xl mb-3"></i>
                            <p class="text-white text-lg font-semibold text-center px-4">Amenities - Disponível em Breve!</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Property Location Map -->
            <div class="property-detail-card p-6 mb-8">
                <h2 class="section-heading">Localização</h2>
                <div id="property-map" style="height: 350px; border-radius: 12px;" class="mb-3"></div>
                <p class="text-gray-400 text-sm">
                    <i class="fas fa-info-circle mr-1"></i>
                    A localização apresentada é aproximada para proteção da privacidade do vendedor
                </p>
            </div>
            
            <!-- Contact Info -->
            <div class="property-detail-card p-6 h-fit">
                <h2 class="section-heading">Owner Information</h2>
                <div class="flex items-center mb-4">
                    <div class="w-12 h-12 bg-blue-900 rounded-full flex items-center justify-center mr-3">
                        <i class="fas fa-user text-white"></i>
                    </div>
                    <div>
                        <h3 id="ownerName" class="font-semibold">-</h3>
                        <p id="ownerEmail" class="text-sm text-gray-400">-</p>
                    </div>
                </div>
                <div class="border-t border-gray-700 pt-4 mt-4">
                    <button class="btn-primary w-full mb-3 opacity-50 cursor-not-allowed" disabled>
                        <i class="fas fa-phone-alt mr-2"></i> Contact Owner
                        <i class="fas fa-lock ml-2"></i>
                    </button>
                    <button class="btn-outline w-full opacity-50 cursor-not-allowed" disabled>
                        <i class="fas fa-calendar-alt mr-2"></i> Schedule Visit
                        <i class="fas fa-lock ml-2"></i>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Mobile Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 bg-gray-900 py-4 px-6 flex justify-around items-center border-t border-gray-800 rounded-t-3xl shadow-lg md:hidden">
        <a href="/index.html" class="flex flex-col items-center text-gray-500">
            <i class="fas fa-home text-xl"></i>
            <span class="text-xs mt-1">Home</span>
        </a>
        <a href="#" class="flex flex-col items-center text-gray-500">
            <i class="fas fa-search text-xl"></i>
            <span class="text-xs mt-1">Search</span>
        </a>
        <a href="#" class="flex flex-col items-center text-gray-500">
            <i class="far fa-heart text-xl"></i>
            <span class="text-xs mt-1">Favourites</span>
        </a>
        <a href="/new_listing.html" class="flex flex-col items-center text-gray-500">
            <i class="fas fa-sign-out-alt text-xl"></i>
            <span class="text-xs mt-1">Sell/Rent</span>
        </a>
    </nav>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const API_URL = 'http://localhost:8800/api';
            const token = localStorage.getItem('token');
            
            // Get property ID from URL query params
            const urlParams = new URLSearchParams(window.location.search);
            const propertyId = urlParams.get('id');
            
            if (!propertyId) {
                window.location.href = 'index.html';
                return;
            }
            
            // Auth-related functionality
            if (token) {
                try {
                    const response = await fetch(`${API_URL}/auth/me`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    const data = await response.json();
                    if (response.ok) {
                        document.getElementById('authLinks').style.display = 'none';
                        document.getElementById('userInfo').style.display = 'flex';
                        document.getElementById('username').textContent = data.username;
                    } else {
                        console.error('Failed to fetch user info:', data.message);
                    }
                } catch (error) {
                    console.error('Error fetching user info:', error);
                }
            }

            // Logout functionality
            document.getElementById('logoutBtn').addEventListener('click', async () => {
                try {
                    const response = await fetch(`${API_URL}/auth/logout`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    if (response.ok) {
                        localStorage.removeItem('token');
                        window.location.href = 'index.html';
                    } else {
                        console.error('Failed to logout:', response.statusText);
                    }
                } catch (error) {
                    console.error('Error logging out:', error);
                }
            });
            
            // Function to check if property is favorited
            async function checkIfFavorited(propertyId) {
                if (!token) return false;
                
                try {
                    const response = await fetch(`${API_URL}/posts/user/saved`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (!response.ok) throw new Error('Failed to fetch saved properties');
                    
                    const savedProperties = await response.json();
                    return savedProperties.some(property => property.id === propertyId);
                } catch (error) {
                    console.error('Error checking if property is favorited:', error);
                    return false;
                }
            }
            
            // Function to toggle favorite status
            async function toggleFavorite(propertyId) {
                if (!token) {
                    alert('Please login to save properties');
                    return false;
                }
                
                try {
                    const favoriteBtn = document.getElementById('favoriteBtn');
                    const isFavorite = favoriteBtn.classList.contains('active');
                    
                    if (isFavorite) {
                        // Remove from favorites
                        const response = await fetch(`${API_URL}/posts/save/${propertyId}`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });
                        
                        if (!response.ok) throw new Error('Failed to remove from favorites');
                        
                        // Update UI
                        favoriteBtn.classList.remove('active');
                    } else {
                        // Add to favorites
                        const response = await fetch(`${API_URL}/posts/save`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ postId: propertyId })
                        });
                        
                        if (!response.ok) throw new Error('Failed to add to favorites');
                        
                        // Update UI
                        favoriteBtn.classList.add('active');
                    }
                    
                    return true;
                } catch (error) {
                    console.error('Error toggling favorite:', error);
                    return false;
                }
            }
            
            // Function to fetch property details
            async function fetchPropertyDetails(propertyId) {
                try {
                    const response = await fetch(`${API_URL}/posts/${propertyId}`);
                    if (!response.ok) throw new Error('Failed to fetch property details');
                    
                    const property = await response.json();
                    return property;
                } catch (error) {
                    console.error('Error fetching property details:', error);
                    return null;
                }
            }
            
            // Function to render property details
            async function renderPropertyDetails(property) {
                if (!property) {
                    alert('Property not found');
                    window.location.href = 'index.html';
                    return;
                }
                
                // Update page title
                document.title = `${property.title} - Estate App`;
                
                // Set property details
                document.getElementById('propertyTitle').textContent = property.title;
                document.getElementById('propertyLocation').innerHTML += property.city || 'Location not specified';
                document.getElementById('propertyPrice').textContent = `${property.price.toLocaleString()}€`;
                document.getElementById('bedrooms').textContent = property.bedroom;
                document.getElementById('bathrooms').textContent = property.bathroom;
                document.getElementById('area').textContent = `${property.area} m²`;
                document.getElementById('propertyDescription').textContent = property.description;
                
                // Owner information
                if (property.user) {
                    document.getElementById('ownerName').textContent = property.user.name || property.user.username;
                    document.getElementById('ownerEmail').textContent = property.user.email;
                }
                
                // Render amenities
                if (property.postDetail) {
                    const amenitiesContainer = document.getElementById('amenitiesContainer');
                    amenitiesContainer.innerHTML = '';
                    
                    const amenities = [
                        { name: 'Utilities Included', value: property.postDetail.utilities },
                        { name: 'Pets Allowed', value: property.postDetail.pet },
                        { name: 'Income Verification', value: property.postDetail.income },
                        { name: 'School Nearby', value: property.postDetail.school ? `${property.postDetail.school} km` : false },
                        { name: 'Bus Stop Nearby', value: property.postDetail.bus ? `${property.postDetail.bus} km` : false },
                        { name: 'Restaurants Nearby', value: property.postDetail.restaurant ? `${property.postDetail.restaurant} km` : false }
                    ];
                    
                    amenities.forEach(amenity => {
                        const amenityEl = document.createElement('div');
                        amenityEl.className = 'flex items-center p-2';
                        
                        if (amenity.value === true || (typeof amenity.value === 'string' && amenity.value !== 'false')) {
                            amenityEl.innerHTML = `
                                <div class="feature-indicator feature-available">
                                    <i class="fas fa-check text-xs"></i>
                                </div>
                                <span>${amenity.name}${typeof amenity.value === 'string' && amenity.value !== 'true' ? `: ${amenity.value}` : ''}</span>
                            `;
                        } else if (amenity.value === false || amenity.value === 'false' || amenity.value === null) {
                            amenityEl.innerHTML = `
                                <div class="feature-indicator feature-unavailable">
                                    <i class="fas fa-times text-xs"></i>
                                </div>
                                <span class="text-gray-500">${amenity.name}</span>
                            `;
                        }
                        
                        amenitiesContainer.appendChild(amenityEl);
                    });
                }
                
                // Helper function to fix image URLs
                function getProperImageUrl(imageUrl) {
                    if (!imageUrl) return 'https://via.placeholder.com/300x200/1e293b/ffffff?text=No+Image';
                    if (imageUrl.startsWith('http://') || imageUrl.startsWith('https://')) return imageUrl;
                    if (imageUrl.startsWith('/uploads/')) return `http://localhost:8800/api${imageUrl}`;
                    return `http://localhost:8800/api/uploads/listings/${imageUrl}`;
                }
                
                // Render image gallery
                const imageGallery = document.getElementById('imageGallery');
                
                if (property.images && property.images.length > 0) {
                    // Create image carousel with navigation
                    const imagesHTML = `
                        <div class="image-carousel relative rounded-xl overflow-hidden">
                            <div id="carousel-container" class="w-full h-96 relative">
                                ${property.images.map((image, index) => {
                                    const imageUrl = getProperImageUrl(image);
                                    return `<div class="carousel-slide absolute top-0 left-0 w-full h-full opacity-0 transition-opacity duration-300"
                                                style="${index === 0 ? 'opacity: 1;' : ''}"
                                                data-index="${index}">
                                            <img src="${imageUrl}"
                                                alt="${property.title} image ${index + 1}"
                                                class="w-full h-full object-cover"
                                                onerror="this.onerror=null; this.src='https://via.placeholder.com/800x600/1e293b/ffffff?text=Error+Loading+Image';">
                                        </div>`;
                                }).join('')}
                            </div>
                            
                            ${property.images.length > 1 ? `
                            <button id="prev-slide" class="absolute left-4 top-1/2 transform -translate-y-1/2 bg-black bg-opacity-50 text-white p-2 rounded-full hover:bg-opacity-75">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button id="next-slide" class="absolute right-4 top-1/2 transform -translate-y-1/2 bg-black bg-opacity-50 text-white p-2 rounded-full hover:bg-opacity-75">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                            
                            <div class="absolute bottom-4 left-0 right-0 flex justify-center gap-2">
                                ${property.images.map((_, index) =>
                                    `<button class="carousel-dot w-3 h-3 rounded-full ${index === 0 ? 'bg-white' : 'bg-gray-400'}" data-index="${index}"></button>`
                                ).join('')}
                            </div>
                            ` : ''}
                        </div>`;
                    
                    imageGallery.innerHTML = imagesHTML;
                    
                    // Add carousel functionality
                    if (property.images.length > 1) {
                        const slides = document.querySelectorAll('.carousel-slide');
                        const dots = document.querySelectorAll('.carousel-dot');
                        let currentIndex = 0;
                        
                        const showSlide = (index) => {
                            slides.forEach(slide => slide.style.opacity = '0');
                            dots.forEach(dot => dot.classList.replace('bg-white', 'bg-gray-400'));
                            
                            slides[index].style.opacity = '1';
                            dots[index].classList.replace('bg-gray-400', 'bg-white');
                            currentIndex = index;
                        };
                        
                        document.getElementById('next-slide').addEventListener('click', () => {
                            const nextIndex = (currentIndex + 1) % slides.length;
                            showSlide(nextIndex);
                        });
                        
                        document.getElementById('prev-slide').addEventListener('click', () => {
                            const prevIndex = (currentIndex - 1 + slides.length) % slides.length;
                            showSlide(prevIndex);
                        });
                        
                        dots.forEach((dot, index) => {
                            dot.addEventListener('click', () => {
                                showSlide(index);
                            });
                        });
                    }
                } else {
                    // No images
                    document.getElementById('imageGallery').innerHTML = `
                        <div class="bg-gray-700 rounded-xl h-96 flex items-center justify-center">
                            <p class="text-gray-400">No images available</p>
                        </div>
                    `;
                }
                
                // Initialize the property location map
                if (property.latitude && property.longitude) {
                    const lat = parseFloat(property.latitude);
                    const lng = parseFloat(property.longitude);
                    
                    if (!isNaN(lat) && !isNaN(lng)) {
                        const propertyMap = L.map('property-map').setView([lat, lng], 14);
                        
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                        }).addTo(propertyMap);
                        
                        // Add marker for property location
                        const marker = L.marker([lat, lng]).addTo(propertyMap);
                        
                        // Add a circle to indicate approximate location
                        L.circle([lat, lng], {
                            color: '#3b82f6',
                            fillColor: '#3b82f6',
                            fillOpacity: 0.2,
                            radius: 100  // 100 meters radius for privacy
                        }).addTo(propertyMap);
                        
                        // Add popup with basic property info
                        marker.bindPopup(`
                            <div style="text-align: center;">
                                <h3 style="font-weight: bold; margin-bottom: 5px;">${property.price.toLocaleString()}€</h3>
                                <p>${property.address}, ${property.city}</p>
                            </div>
                        `).openPopup();
                    }
                } else {
                    document.getElementById('property-map').innerHTML = `
                        <div class="flex items-center justify-center h-full">
                            <p class="text-gray-400">Localização não disponível</p>
                        </div>
                    `;
                }
                
                // Check if property is favorited
                const isFavorited = await checkIfFavorited(property.id);
                const favoriteBtn = document.getElementById('favoriteBtn');
                
                if (isFavorited) {
                    favoriteBtn.classList.add('active');
                }
                
                // Add favorite button event listener
                favoriteBtn.addEventListener('click', async () => {
                    const success = await toggleFavorite(property.id);
                    if (success) {
                        favoriteBtn.classList.toggle('active');
                    }
                });
            }
            
            // Fetch and render property details
            const property = await fetchPropertyDetails(propertyId);
            renderPropertyDetails(property);
        });
    </script>
</body>
</html>
`````