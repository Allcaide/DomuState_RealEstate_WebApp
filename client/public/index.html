<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estate App - Dark Edition</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" rel="stylesheet" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin=""/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" rel="stylesheet" />
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="/js/script.js"></script>
    
</head>
<body>
    <!-- Header with gradient background -->
    <header class="header-gradient text-white pt-6 pb-8 px-0 mb-8 fixed-header">
        <div class="w-full relative px-10">
            <div class="flex justify-between items-center mb-8">
                <a href="/index.html" class="text-2xl font-bold pl-0 ml-0">DomuState</a>
                
                <!-- Navigation Links - Desktop -->
                <nav class="hidden md:flex space-x-10">
                    <a href="/index.html" class="nav-link active">Home</a>
                    <a href="/favorites.html" class="nav-link">Favorites</a>
                    <a href="/new_listing.html" class="nav-link">Sell</a>
                    <!-- Locked feature with padlock icon -->
                    <a href="#" class="nav-link locked-feature" style="pointer-events: none">
                        <span class="flex items-center gap-2 opacity-50">
                            Renovate
                            <i class="fas fa-lock text-sm"></i>
                        </span>
                    </a>
                </nav>
                
                <!-- Placeholder para manter o grid balanceado -->
                
                
                <!-- Auth Links - Desktop -->
                <div class="hidden md:flex items-center space-x-4 auth-links" id="authLinks">
                    <a href="/login.html" class="auth-btn">Sign in</a>
                    <span class="text-white opacity-50">|</span>
                    <a href="/register.html" class="auth-btn">Sign up</a>
                </div>
                
                <!-- User Info - Desktop -->
                <div class="hidden md:flex items-center space-x-4 auth-linkslogout" id="userInfo" style="display: none;">
                    <i class="fas fa-user text-white"></i>
                    <a href="/user-profile.html" id="username" class="text-white transition-all duration-150 hover:text-blue-200 hover:-translate-y-0.5"></a>
                    <button id="logoutBtn" class="text-white transition-all duration-150 hover:text-blue-200 hover:-translate-y-0.5">Logout</button>
                </div>
                <button id="toggleMapDrawer" class="fixed right-5" style="top: 76px; z-index:60; display: flex; align-items: center; gap: 0.5rem; background: #1e40af; color: white; padding: 0.5rem 0.75rem; border-radius: 0.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.12); font-weight: 600; font-size: 1rem;">
                    <span class="text-base font-semibold tracking-wide">Filter</span>
                    <span id="toggleMapDrawerIcon" class="block">
                        <!-- SVG Filtro meio vazio (recolhido) -->
                        <svg id="filterIconEmpty" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><polygon points="3 4 21 4 14 14 14 20 10 20 10 14 3 4" fill="none"/><polygon points="3 4 21 4 14 14 14 20 10 20 10 14 3 4" fill="currentColor" fill-opacity="0.3"/></svg>
                        <!-- SVG Filtro meio cheio (aberto) -->
                        <svg id="filterIconFull" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" style="display:none;"><polygon points="3 4 21 4 14 14 14 20 10 20 10 14 3 4" fill="currentColor" fill-opacity="0.7"/><polygon points="3 4 21 4 14 14 14 20 10 20 10 14 3 4" fill="none"/></svg>
                    </span>
                </button>
                
                <!-- Mobile menu button -->
                <button class="md:hidden p-2 rounded-full bg-white bg-opacity-10 hover:bg-opacity-20 transition-all duration-150">
                    <i class="fas fa-bars text-white"></i>
                </button>
            </div>
            <!-- Enhanced Filter Section (Hidden by Default) -->
            <div id="filterSection" class="search-bar w-full flex-wrap items-center px-5 py-4 text-white mb-6 hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-map-marker-alt text-white opacity-80"></i>
                        <select id="cityFilter" class="bg-transparent outline-none text-white w-full">
                            <option value="">All Cities</option>
                        </select>
                    </div>
                    
                    
                    
                    
                    
                    
                </div>
                


            </div>
            
            
            <!-- Search Bar -->
            
        </div>
    </header>

    <!-- Main content with two-column layout -->
    <main class="content-wrapper main-properties-container">
        <!-- Two-column layout for map and properties -->
        <div class="flex flex-col-reverse lg:flex-row mb-12">
            <!-- Left side: Property listings -->
            <div class="properties-listing-col" style="position: relative; z-index: 20;">
                <!-- All Properties Section -->
                <section class="mb-24">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold">Properties</h2>
                    </div>
                    <div id="allProperties">
                        <!-- All properties will be loaded here dynamically -->
                        <div class="text-center w-full col-span-full">
                            <p class="text-gray-400">Loading properties...</p>
                        </div>
                    </div>
                    <div id="seeMoreContainer" class="flex justify-center mt-8"></div>
                </section>
            </div>
            
            <!-- Right side: Portugal Map with Property Locations -->
            <div class="map-sidebar">
                <div class="property-detail-card p-6 bg-gray-800 rounded-xl shadow-lg flex flex-col gap-0" style="max-height:90vh; overflow-y:auto;">
                    <h2 class="text-xl font-bold mb-4">Property Map</h2>
                    <div id="portugal-map" style="height: 700px; width: 100%; z-index: 10; position: relative;" class="rounded-xl border border-gray-700"></div>
                    <div class="location-search mb-6 mt-4">
                        <input type="text" id="locationSearch" placeholder="Search location (e.g. Lisboa, Porto)" class="w-full px-4 py-2 rounded-lg bg-gray-700 text-white placeholder-gray-400 border-none focus:ring-2 focus:ring-blue-500" />
                    </div>
                    <div id="detailedFilterSection" class="w-full bg-gray-700 bg-opacity-90 rounded-2xl px-6 py-6 mb-4 shadow-lg flex flex-col gap-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 lg:grid-cols-3">
                            <div class="flex flex-col gap-1">
                                <label class="text-sm font-semibold mb-1" for="districtFilter"><i class="fas fa-map-marker-alt mr-2"></i>District</label>
                                <select id="districtFilter" class="bg-gray-800 text-white rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500">
                                    <option value="">Todos os Distritos</option>
                                    <option value="Aveiro">Aveiro</option>
                                    <option value="Beja">Beja</option>
                                    <option value="Braga">Braga</option>
                                    <option value="Bragança">Bragança</option>
                                    <option value="Castelo Branco">Castelo Branco</option>
                                    <option value="Coimbra">Coimbra</option>
                                    <option value="Évora">Évora</option>
                                    <option value="Faro">Faro</option>
                                    <option value="Guarda">Guarda</option>
                                    <option value="Leiria">Leiria</option>
                                    <option value="Lisboa">Lisboa</option>
                                    <option value="Portalegre">Portalegre</option>
                                    <option value="Porto">Porto</option>
                                    <option value="Santarém">Santarém</option>
                                    <option value="Setúbal">Setúbal</option>
                                    <option value="Viana do Castelo">Viana do Castelo</option>
                                    <option value="Vila Real">Vila Real</option>
                                    <option value="Viseu">Viseu</option>
                                    <option value="Açores">Açores</option>
                                    <option value="Madeira">Madeira</option>
                                </select>
                            </div>
                            <div class="flex flex-col gap-1">
                                <label class="text-sm font-semibold mb-1" for="minPrice"><i class="fas fa-euro-sign mr-2"></i>Min Price (€)</label>
                                <input id="minPrice" type="number" min="0" placeholder="Preço mínimo" class="bg-gray-800 text-white rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500" />
                            </div>
                            <div class="flex flex-col gap-1">
                                <label class="text-sm font-semibold mb-1" for="maxPrice"><i class="fas fa-euro-sign mr-2"></i>Max Price (€)</label>
                                <input id="maxPrice" type="number" min="0" placeholder="Preço máximo" class="bg-gray-800 text-white rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500" />
                            </div>
                            <div class="flex flex-col gap-1">
                                <label class="text-sm font-semibold mb-1" for="bedroomFilter"><i class="fas fa-bed mr-2"></i>Bedrooms</label>
                                <select id="bedroomFilter" class="bg-gray-800 text-white rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500">
                                    <option value="">Any Bedrooms</option>
                                    <option value="1">1+ Bedroom</option>
                                    <option value="2">2+ Bedrooms</option>
                                    <option value="3">3+ Bedrooms</option>
                                    <option value="4">4+ Bedrooms</option>
                                </select>
                            </div>
                            <div class="flex flex-col gap-1">
                                <label class="text-sm font-semibold mb-1" for="bathroomFilter"><i class="fas fa-bath mr-2"></i>Bathrooms</label>
                                <select id="bathroomFilter" class="bg-gray-800 text-white rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500">
                                    <option value="">Any Bathrooms</option>
                                    <option value="1">1+ Bathroom</option>
                                    <option value="2">2+ Bathrooms</option>
                                    <option value="3">3+ Bathrooms</option>
                                </select>
                            </div>

                            <div class="flex flex-col gap-1">
                                <label class="text-sm font-semibold mb-1" for="areaFilter"><i class="fas fa-ruler-combined mr-2"></i>Area</label>
                                <select id="areaFilter" class="bg-gray-800 text-white rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500">
                                    <option value="">Any Area</option>
                                    <option value="0-50"> 50 m²</option>
                                    <option value="50-100">50 - 100 m²</option>
                                    <option value="100-150">100 - 150 m²</option>
                                    <option value="150-200">150 - 200 m²</option>
                                    <option value="200-99999">> 200 m²</option>
                                </select>
                            </div>
                            <div class="flex flex-col gap-1">
                                <label class="text-sm font-semibold mb-1" for="sortFilter"><i class="fas fa-sort mr-2"></i>Sort</label>
                                <select id="sortFilter" class="bg-gray-800 text-white rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500">
                                    <option value="createdAt-desc">Newest First</option>
                                    <option value="price-asc">Price: Low to High</option>
                                    <option value="price-desc">Price: High to Low</option>
                                    <option value="area-asc">Area: Small to Large</option>
                                    <option value="area-desc">Area: Large to Small</option>
                                </select>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Mobile Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 bg-gray-900 py-4 px-6 flex justify-around items-center border-t border-gray-800 rounded-t-3xl shadow-lg md:hidden">
        <a href="/index.html" class="flex flex-col items-center text-blue-500">
            <i class="fas fa-home text-xl"></i>
            <span class="text-xs mt-1 font-medium">Home</span>
        </a>
        <a href="#" class="flex flex-col items-center text-gray-500">
            <i class="fas fa-search text-xl"></i>
            <span class="text-xs mt-1">Search</span>
        </a>
        <a href="/favorites.html" class="flex flex-col items-center text-gray-500">
            <i class="far fa-heart text-xl"></i>
            <span class="text-xs mt-1">Favourites</span>
        </a>
        <a href="/new_listing.html" class="flex flex-col items-center text-gray-500">
            <i class="fas fa-sign-out-alt text-xl"></i>
            <span class="text-xs mt-1">Sell/Rent</span>
        </a>
    </nav>

    <!-- Map/Filter Drawer (hidden by default) -->
    <div id="mapFilterDrawer" class="fixed top-0 right-0 h-full w-full max-w-xl bg-gray-900 shadow-2xl z-40 transform translate-x-full transition-transform duration-300 overflow-y-auto" style="max-width: 480px;">
        <div class="p-6">
            <h2 class="text-xl font-bold mb-4">Map & Filters</h2>
            <!-- Map Section First -->
            <div id="drawerMapSection" class="mb-6"></div>
            <!-- Filters Section Below -->
            <div id="drawerFilterSection"></div>
        </div>
    </div>

    <script>
        console.log('[DEBUG] Script index.html carregado');
        const token = localStorage.getItem('token');
        console.log('[DEBUG] Token lido do localStorage:', token);

        document.addEventListener('DOMContentLoaded', async () => {
            // Global variables
            const API_URL = 'http://localhost:8800/api';
            let currentPage = 1;
            let totalPages = 1;
            const LISTINGS_PER_PAGE = 30;
            let currentFilters = {};
            let cities = new Set();

            // Helper function to get proper image URL (With help of AI GPT4.1)
            function getProperImageUrl(imageUrl) {
                if (!imageUrl) return 'https://via.placeholder.com/300x200/1e293b/ffffff?text=No+Image';
                if (imageUrl.startsWith('http://') || imageUrl.startsWith('https://')) return imageUrl;
                if (imageUrl.startsWith('/uploads/')) return `http://localhost:8800/api${imageUrl}`;
                return `http://localhost:8800/api/uploads/listings/${imageUrl}`;
            }
            
            // Auth-related functionality
            if (token) {
                try {
                    const response = await fetch(`${API_URL}/auth/me`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    const data = await response.json();
                    if (response.ok) {
                        document.getElementById('authLinks').style.display = 'none';
                        document.getElementById('userInfo').style.display = 'flex';
                        document.getElementById('username').textContent = data.username;
                    } else {
                        console.error('Failed to fetch user info:', data.message);
                    }
                } catch (error) {
                    console.error('Error fetching user info:', error);
                }
            }

            // Logout functionality
            document.getElementById('logoutBtn').addEventListener('click', async () => {
                try {
                    const response = await fetch(`${API_URL}/auth/logout`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    if (response.ok) {
                        localStorage.removeItem('token');
                        window.location.href = 'index.html';
                    } else {
                        console.error('Failed to logout:', response.statusText);
                    }
                } catch (error) {
                    console.error('Error logging out:', error);
                }
            });
            
            // Function to create property card HTML
            function createPropertyCard(property) {
                let imageUrl = 'https://via.placeholder.com/300x200/1e293b/ffffff?text=No+Image';
                
                if (property.images && property.images.length > 0) {
                    imageUrl = getProperImageUrl(property.images[0]);
                }
                
                return `
                <div class="card" data-id="${property.id}">
                    <div class="relative">
                        <img src="${imageUrl}"
                             alt="${property.title}"
                             class="property-image w-full"
                             onerror="this.onerror=null; this.src='https://via.placeholder.com/300x200/1e293b/ffffff?text=Error+Loading+Image';">
                        <button class="favorite-btn absolute top-4 right-4 heart-icon p-2 rounded-full bg-white" data-id="${property.id}">
                            <i class="fas fa-heart${property.isFavorite ? ' text-red-500' : ' text-gray-500'}"></i>
                        </button>
                    </div>
                    <div class="p-5">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-lg font-bold">${property.title}</h3>
                            <span class="price-tag">${property.price.toLocaleString()}€</span>
                        </div>
                        <p class="location-text mb-3">
                            <i class="fas fa-map-marker-alt mr-1"></i> ${property.city}
                        </p>
                        <div class="flex items-center justify-between text-sm text-gray-400 mb-1">
                            <div>
                                <i class="fas fa-bed mr-1"></i> ${property.bedroom} bd
                            </div>
                            <div>
                                <i class="fas fa-bath mr-1"></i> ${property.bathroom} ba
                            </div>
                            <div>
                                <i class="fas fa-ruler-combined mr-1"></i> ${property.area} m²
                            </div>
                        </div>
                    </div>
                </div>
                `;
            }
            
            // Function to fetch all properties
            async function fetchAllProperties(page = 1, filters = {}) {
                try {
                    // Build query string from filters with help of GPT4.0
                    const queryParams = new URLSearchParams();
                    queryParams.append('page', page);
                    queryParams.append('limit', LISTINGS_PER_PAGE); // 30 properties per page
                    
                    // Add default sorting if no filters specified
                    if (!filters.sort) {
                        queryParams.append('sort', 'createdAt');
                        queryParams.append('order', 'desc');
                    }
                    
                    // Add filters to query params
                    if (filters.city) queryParams.append('city', filters.city);
                    if (filters.minPrice) queryParams.append('minPrice', filters.minPrice);
                    if (filters.maxPrice) queryParams.append('maxPrice', filters.maxPrice);
                    if (filters.bedrooms) queryParams.append('bedrooms', filters.bedrooms);
                    if (filters.bathrooms) queryParams.append('bathrooms', filters.bathrooms);
                    if (filters.minArea) queryParams.append('minArea', filters.minArea);
                    if (filters.maxArea) queryParams.append('maxArea', filters.maxArea);
                    if (filters.sort) queryParams.append('sort', filters.sort);
                    if (filters.order) queryParams.append('order', filters.order);
                    if (filters.title) queryParams.append('title', filters.title);

                    const response = await fetch(`${API_URL}/posts?${queryParams.toString()}`);

                    if (!response.ok) throw new Error('Failed to fetch properties');
                    
                    const data = await response.json();
                    return data;
                } catch (error) {
                    console.error('Error fetching properties:', error);
                    return { posts: [], pagination: { total: 0, page: 1, pages: 1 } };
                }
            }
            
            // Function to fetch favorite properties
            async function fetchFavoriteProperties() {
                if (!token) return [];
                
                try {
                    const response = await fetch(`${API_URL}/posts/favorites`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (!response.ok) throw new Error('Failed to fetch favorite properties');
                    
                    const data = await response.json();
                    return data;
                } catch (error) {
                    console.error('Error fetching favorite properties:', error);
                    return [];
                }
            }
            
            // Function to fetch saved/favorite properties
            async function fetchSavedProperties() {
                if (!token) return [];
                
                try {
                    const response = await fetch(`${API_URL}/posts/user/saved`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (!response.ok) throw new Error('Failed to fetch saved properties');
                    
                    const data = await response.json();
                    return data.map(post => post.id);
                } catch (error) {
                    console.error('Error fetching saved properties:', error);
                    return [];
                }
            }
            
            // Function to toggle favorite status With Help of AI 3.5Sonnet
            async function toggleFavorite(postId, isCurrentlyFavorite) {
                try {
                    let response;
                    if (isCurrentlyFavorite) {
                        // Remove dos favoritos
                        response = await fetch(`${API_URL}/posts/save/${postId}`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });
                    } else {
                        // Adiciona aos favoritos
                        response = await fetch(`${API_URL}/posts/save`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ postId })
                        });
                    }
                    if (!response.ok) throw new Error('Failed to toggle favorite');
                    return true;
                } catch (error) {
                    console.error('Error toggling favorite:', error);
                    return false;
                }
            }
            
            // Function to update UI with properties
            async function displayProperties() {
                console.log('[DEBUG] A chamar displayProperties()');
                // Get container elements
                const allPropertiesContainer = document.getElementById('allProperties');
                
                // Show loading indicator for all properties
                allPropertiesContainer.innerHTML = '<div class="text-center w-full col-span-full"><p class="text-gray-400">Loading properties...</p></div>';
                
                // Fetch favorite properties
                const savedPropertyIds = await fetchSavedProperties();
                
                // Fetch and display all properties
                currentFilters.sort = 'createdAt';
                currentFilters.order = 'desc';
                const data = await fetchAllProperties(currentPage, currentFilters);
                
                if (data.posts.length > 0) {
                    window.lastLoadedProperties = data.posts;
                    totalPages = data.pagination.pages;
                    // Mark favorites BEFORE rendering cards
                    const savedIds = savedPropertyIds.map(id => id.toString());
                    data.posts.forEach(property => {
                        property.isFavorite = savedIds.includes(property.id.toString());
                        
                        // Add city to set for filter options
                        if (property.city) cities.add(property.city);
                    });
                    
                    allPropertiesContainer.innerHTML = data.posts.map(createPropertyCard).join('');
                } else {
                    allPropertiesContainer.innerHTML = '<div class="text-center w-full col-span-full"><p class="text-gray-400">No properties match your criteria</p></div>';
                }
                
                updateSeeMoreButton();
                
                // After all properties are loaded, update city filter options
                populateCityFilter();
                
                // Atualizar UI do botão favorito após toggle
                document.querySelectorAll('.favorite-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        e.preventDefault();
                        const postId = btn.getAttribute('data-id');
                        const icon = btn.querySelector('i');
                        const isFavorite = icon.classList.contains('text-red-500');
                        // Atualiza visual imediatamente
                        icon.classList.toggle('text-red-500');
                        btn.classList.add('animated');
                        setTimeout(() => btn.classList.remove('animated'), 300);
                        const success = await toggleFavorite(postId, isFavorite);
                        if (!success) {
                            // Reverte se falhar
                            icon.classList.toggle('text-red-500');
                        }
                    });
                });
                
                // Add event listeners to property cards for navigation
                document.querySelectorAll('.card').forEach(card => {
                    card.addEventListener('click', (e) => {
                        // Only navigate if the click wasn't on the favorite button
                        if (!e.target.closest('.favorite-btn')) {
                            const propertyId = card.getAttribute('data-id');
                            window.location.href = `property.html?id=${propertyId}`;
                        }
                    });
                });
            }
            
            function updateSeeMoreButton() {
                const seeMoreContainer = document.getElementById('seeMoreContainer');
                if (totalPages > 1 && currentPage < totalPages) {
                    seeMoreContainer.innerHTML = `
                        <button id="seeMoreBtn" class="px-6 py-2 bg-blue-800 text-white rounded-lg shadow hover:bg-blue-700 transition">
                            See more
                        </button>
                    `;
                    document.getElementById('seeMoreBtn').onclick = async () => {
                        currentPage++;
                        await appendProperties();
                    };
                } else {
                    seeMoreContainer.innerHTML = '';
                }
            }

            async function appendProperties() {
                const allPropertiesContainer = document.getElementById('allProperties');
                const data = await fetchAllProperties(currentPage, currentFilters);
                const savedPropertyIds = await fetchSavedProperties();
                if (data.posts.length > 0) {
                    data.posts.forEach(property => {
                        property.isFavorite = savedPropertyIds.includes(property.id);
                    });
                    allPropertiesContainer.innerHTML += data.posts.map(createPropertyCard).join('');
                }
                totalPages = data.pagination.pages;
                updateSeeMoreButton();
                // Re-add event listeners for new cards
                document.querySelectorAll('.favorite-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        e.preventDefault();
                        const postId = btn.getAttribute('data-id');
                        const icon = btn.querySelector('i');
                        const isFavorite = icon.classList.contains('text-red-500');
                        // Atualiza visual imediatamente
                        icon.classList.toggle('text-red-500');
                        btn.classList.add('animated');
                        setTimeout(() => btn.classList.remove('animated'), 300);
                        const success = await toggleFavorite(postId, isFavorite);
                        if (!success) {
                            // Reverte se falhar
                            icon.classList.toggle('text-red-500');
                        }
                    });
                });
                document.querySelectorAll('.card').forEach(card => {
                    card.addEventListener('click', (e) => {
                        if (!e.target.closest('.favorite-btn')) {
                            const propertyId = card.getAttribute('data-id');
                            window.location.href = `property.html?id=${propertyId}`;
                        }
                    });
                });
            }
            
            // Function to populate city filter dropdown
            function populateCityFilter() {
                const cityFilter = document.getElementById('cityFilter');
                cityFilter.innerHTML = '<option value="">All Cities</option>';
                
                // Add city options alphabetically
                [...cities].sort().forEach(city => {
                    const option = document.createElement('option');
                    option.value = city;
                    option.textContent = city;
                    cityFilter.appendChild(option);
                });
            }
            
            // Initialize page with properties
            await displayProperties();
            
            // Initialize map with a delay to ensure container is fully loaded
            console.log("Setting up map initialization");
            setTimeout(() => {
                console.log("Initializing map");
                initializePortugalMap([]);
            }, 80);
            
            // Toggle filter visibility
            const toggleFiltersBtn = document.getElementById('toggleFilters');
            if (toggleFiltersBtn) {
                toggleFiltersBtn.addEventListener('click', () => {
                    const filterSection = document.getElementById('filterSection');
                    filterSection.classList.toggle('hidden');
                    
                    // Initialize map when filters are shown for the first time
                    if (!filterSection.classList.contains('hidden') && !window.filterMapInitialized) {
                        initializeFilterMap();
                        window.filterMapInitialized = true;
                    }
                });
            }
            
            // Function to initialize the filter map, built with help of GPT4.1
            function initializeFilterMap() {
                console.log("Initializing filter map");
                const mapElement = document.getElementById('map-filter');
                if (!mapElement) {
                    console.error('Map element with id "map-filter" not found.');
                    return;
                }
                // Remove mapa anterior se existir
                if (window.filterMap) {
                    window.filterMap.remove();
                }
                window.filterMap = L.map('map-filter', {
                    scrollWheelZoom: true,
                    zoomControl: true
                }).setView([39.5, -8.0], 6);
                L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/toner/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(window.filterMap);
                // Não adicionar controlos de desenho, polígonos ou botões extra
            }
            
            // Portugal Map with Properties Initialization
            function initializePortugalMap(properties) {
                console.log("Starting Portugal map initialization");
                const mapElement = document.getElementById('portugal-map');
                if (!mapElement) {
                    console.error('Map element with id "portugal-map" not found.');
                    return;
                }

                // Initialize markers object to track markers by location
                const markers = {};
                
                try {
                    // Remove existing map if it exists
                    if (window.portugalMap) {
                        console.log("Removing existing Portugal map");
                        window.portugalMap.remove();
                    }
                    
                    console.log("Creating new Portugal map instance");
                    window.portugalMap = L.map(mapElement, {
                        scrollWheelZoom: true,
                        zoomControl: true
                    }).setView([39.5, -8.0], 7); // Larger initial zoom level
                    
                    // Add tile layer
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                        maxZoom: 19
                    }).addTo(window.portugalMap);
                    
                    console.log("Map initialized successfully");
                    
                    // Add sample markers for major cities
                    const cityMarkers = [

                    ];
                    
                    cityMarkers.forEach(city => {
                        L.marker([city.lat, city.lng])
                          .addTo(window.portugalMap)
                          .bindPopup(`<div style="color: #1e293b; padding: 8px;"><strong>${city.content}</strong></div>`);
                    });
                } catch (error) {
                    console.error("Error initializing map:", error);
                    return;
                }
                
                // Add markers for properties
                if (properties && properties.length > 0) {
                    properties.forEach(property => {
                        if (property.latitude && property.longitude) {
                            const locationKey = `${property.latitude}_${property.longitude}`;
                            
                            // Check if a marker already exists at this location
                            if (markers[locationKey]) {
                                // Marker exists, append information or handle as needed
                                const existingPopupContent = markers[locationKey].getPopup().getContent();
                                const newContent = `
                                    ${existingPopupContent}
                                    <hr style="margin: 10px 0; border-color: #4a5568;">
                                    <h3 style="font-size: 1.1em; font-weight: 700; margin-bottom: 4px; color: #1a202c;">${property.title}</h3>
                                    <p style="font-size: 0.9em; margin-bottom: 4px; color: #4a5568;">
                                        <i class="fas fa-map-marker-alt" style="margin-right: 5px; color: #2b6cb0;"></i>${property.city}
                                    </p>
                                    <p style="font-size: 1em; font-weight: 600; margin-bottom: 8px; color: #2b6cb0;">${property.price.toLocaleString()} €</p>
                                    <a href="/property.html?id=${property.id}" 
                                       target="_blank" 
                                       style="display: inline-block; background-color: #2b6cb0; color: white; padding: 8px 14px; border-radius: 8px; text-decoration: none; font-size: 0.9em; font-weight: 500; transition: background-color 0.2s ease;">
                                        View Details <i class="fas fa-arrow-right" style="margin-left: 5px;"></i>
                                    </a>
                                `;
                                markers[locationKey].setPopupContent(newContent);
                            } else {
                                // Create a new marker
                                const marker = L.marker([property.latitude, property.longitude]).addTo(window.portugalMap);
                                
                                // Store the marker
                                markers[locationKey] = marker;

                                // DEBUG: Log property data for the map
                                console.log('Property para o mapa:', property.id, property.title, property.images); 

                                // Create popup content
                                const popupContent = `
                                    <div style="max-width: 280px; font-family: 'SF Pro Display', sans-serif; color: #333;">
                                        <img src="${getProperImageUrl(property.images && property.images.length > 0 ? property.images[0] : '')}" 
                                             alt="${property.title}" 
                                             style="width:100%; height: 160px; object-fit:cover; border-radius:12px; margin-bottom:10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                                        <h3 style="font-size: 1.1em; font-weight: 700; margin-bottom: 4px; color: #1a202c;">${property.title}</h3>
                                        <p style="font-size: 0.9em; margin-bottom: 4px; color: #4a5568;">
                                            <i class="fas fa-map-marker-alt" style="margin-right: 5px; color: #2b6cb0;"></i>${property.city}
                                        </p>
                                        <p style="font-size: 1em; font-weight: 600; margin-bottom: 8px; color: #2b6cb0;">${property.price.toLocaleString()} €</p>
                                        <a href="/property.html?id=${property.id}" 
                                           target="_blank" 
                                           style="display: inline-block; background-color: #2b6cb0; color: white; padding: 8px 14px; border-radius: 8px; text-decoration: none; font-size: 0.9em; font-weight: 500; transition: background-color 0.2s ease;">
                                            View Details <i class="fas fa-arrow-right" style="margin-left: 5px;"></i>
                                        </a>
                                    </div>
                                `;
                                // DEBUG: Log generated image URL for the pop-up
                                console.log('URL da imagem para o pop-up:', getProperImageUrl(property.images && property.images.length > 0 ? property.images[0] : ''));
                                marker.bindPopup(popupContent);
                            }
                        }
                    });
                }
            }
            
            


            // Atualiza automaticamente ao mudar qualquer filtro, solved all errors with help of GPT4.1
            ['districtFilter','minPrice','maxPrice','bedroomFilter','bathroomFilter','areaFilter','sortFilter'].forEach(id => {
              const el = document.getElementById(id);
              if (el) {
                el.addEventListener('change', async () => {
                  // Corrigido: evitar erro se o input não existir
                  const searchInputEl = document.getElementById('locationSearch');
                  const searchInput = searchInputEl ? searchInputEl.value : '';
                  const districtFilter = document.getElementById('districtFilter').value;
                  const minPrice = document.getElementById('minPrice').value;
                  const maxPrice = document.getElementById('maxPrice').value;
                  const bedroomFilter = document.getElementById('bedroomFilter').value;
                  const bathroomFilter = document.getElementById('bathroomFilter').value;
                  const areaFilter = document.getElementById('areaFilter').value;
                  const sortFilter = document.getElementById('sortFilter').value;
                  currentPage = 1;
                  currentFilters = {};
                  if (searchInput) currentFilters.title = searchInput;
                  if (districtFilter) currentFilters.city = districtFilter;
                  if (minPrice) currentFilters.minPrice = minPrice;
                  if (maxPrice) currentFilters.maxPrice = maxPrice;
                  if (bedroomFilter) currentFilters.bedrooms = bedroomFilter;
                  if (bathroomFilter) currentFilters.bathrooms = bathroomFilter;
                  if (areaFilter) {
                    const [min, max] = areaFilter.split('-');
                    if (min) currentFilters.minArea = min;
                    if (max) currentFilters.maxArea = max;
                  }
                  if (sortFilter) {
                    const [sort, order] = sortFilter.split('-');
                    currentFilters.sort = sort;
                    currentFilters.order = order;
                  } else {
                    currentFilters.sort = 'createdAt';
                    currentFilters.order = 'desc';
                  }
                  const allPropertiesContainer = document.getElementById('allProperties');
                  allPropertiesContainer.innerHTML = '<div class="text-center w-full col-span-full"><p class="text-gray-400">Loading properties...</p></div>';
                  const data = await fetchAllProperties(currentPage, currentFilters);
                  const savedPropertyIds = await fetchSavedProperties();
                  totalPages = data.pagination.pages;
                  if (data.posts.length > 0) {
                    data.posts.forEach(property => {
                      property.isFavorite = savedPropertyIds.includes(property.id);
                    });
                    allPropertiesContainer.innerHTML = data.posts.map(createPropertyCard).join('');
                  } else {
                    allPropertiesContainer.innerHTML = '<div class="text-center w-full col-span-full"><p class="text-gray-400">No properties match your criteria</p></div>';
                  }
                  updateSeeMoreButton();
                  document.querySelectorAll('.favorite-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                      e.preventDefault();
                      const postId = btn.getAttribute('data-id');
                      const icon = btn.querySelector('i');
                      const isFavorite = icon.classList.contains('text-red-500');
                      // Atualiza visual imediatamente
                      icon.classList.toggle('text-red-500');
                      btn.classList.add('animated');
                      setTimeout(() => btn.classList.remove('animated'), 300);
                      const success = await toggleFavorite(postId, isFavorite);
                      if (!success) {
                        // Reverte se falhar
                        icon.classList.toggle('text-red-500');
                      }
                    });
                  });
                  document.querySelectorAll('.card').forEach(card => {
                    card.addEventListener('click', (e) => {
                      if (!e.target.closest('.favorite-btn')) {
                        const propertyId = card.getAttribute('data-id');
                        window.location.href = 'property.html?id=' + propertyId;
                      }
                    });
                  });
                  document.querySelector('section:last-of-type').scrollIntoView({ behavior: 'smooth' });
                });
              }
            });

            // Location search functionality
            document.getElementById('locationSearch').addEventListener('input', async function(e) {
                const searchTerm = e.target.value.toLowerCase();
                if (searchTerm.length >= 3) {
                    // Filtra pelo campo title em vez de city
                    currentFilters.title = searchTerm;
                    currentPage = 1;
                    await displayProperties();
                } else if (searchTerm.length === 0) {
                    // Limpa o filtro de title se o campo for apagado
                    delete currentFilters.title;
                    currentPage = 1;
                    await displayProperties();
                }
            });
            
            // Handle window scroll to fix header
            window.addEventListener('scroll', function() {
                const header = document.querySelector('.fixed-header');
                
                if (window.scrollY > 10) {
                    header.style.boxShadow = '0 4px 10px rgba(0, 0, 0, 0.1)';
                } else {
                    header.style.boxShadow = 'none';
                }
            });

            // Drawer toggle logic, the toggle was learned through various AI models including GPT4.0 and 4.1
            const toggleMapDrawerBtn = document.getElementById('toggleMapDrawer');
            const mapFilterDrawer = document.getElementById('mapFilterDrawer');
            let drawerOpen = false;
            // SVG icon refs
            const filterIconEmpty = document.getElementById('filterIconEmpty');
            const filterIconFull = document.getElementById('filterIconFull');

            // Move filter section and map into drawer on open, restore on close
            const headerFilterSection = document.getElementById('filterSection'); // This is the one in the header
            const detailedFilterSection = document.getElementById('detailedFilterSection'); // This is the one from the sidebar
            const portugalMapContainer = document.getElementById('portugal-map'); // Initial map container in sidebar
            const drawerFilterSection = document.getElementById('drawerFilterSection');
            const drawerMapSection = document.getElementById('drawerMapSection');
            const mapSidebar = document.querySelector('.map-sidebar');
            const sidebarDetailCard = mapSidebar ? mapSidebar.querySelector('.property-detail-card') : null;

            function openDrawer() {
                mapFilterDrawer.classList.remove('translate-x-full');
                mapFilterDrawer.classList.add('translate-x-0');
                drawerOpen = true;
                // Alterna ícone para "meio cheio"
                if (filterIconEmpty && filterIconFull) {
                    filterIconEmpty.style.display = 'none';
                    filterIconFull.style.display = 'block';
                }
                // Remove mapa antigo do drawer se existir
                const oldMap = document.getElementById('portugal-map');
                if (oldMap) oldMap.remove();
                // Cria novo div para o mapa no drawer
                const newMapDiv = document.createElement('div');
                newMapDiv.id = 'portugal-map';

                newMapDiv.style.width = '100%';
                newMapDiv.className = 'rounded-xl border border-gray-700';
                drawerMapSection.innerHTML = '';
                drawerMapSection.appendChild(newMapDiv);
                // Move detailed filters (from sidebar) to the drawer
                if (detailedFilterSection && drawerFilterSection) {
                    drawerFilterSection.appendChild(detailedFilterSection);
                    // No need to toggle 'hidden' class if it's always visible within its container
                }
                if (mapSidebar) mapSidebar.style.display = 'none';
                document.body.classList.add('drawer-open');
                setTimeout(() => {
                    if (window.portugalMap) {
                        window.portugalMap.remove();
                        window.portugalMap = null;
                    }
                    const props = window.lastLoadedProperties || [];
                    initializePortugalMap(props);
                }, 200);
            }

            function closeDrawer() {
                mapFilterDrawer.classList.add('translate-x-full');
                mapFilterDrawer.classList.remove('translate-x-0');
                drawerOpen = false;
                // Alterna ícone para "meio vazio"
                if (filterIconEmpty && filterIconFull) {
                    filterIconEmpty.style.display = 'block';
                    filterIconFull.style.display = 'none';
                }
                // Remove mapa antigo do drawer se existir
                const oldMap = document.getElementById('portugal-map');
                if (oldMap) oldMap.remove();
                // Cria novo div para o mapa na sidebar
                const newMapDiv = document.createElement('div');
                newMapDiv.id = 'portugal-map';
                newMapDiv.style.width = '100%';
                newMapDiv.className = 'rounded-xl border border-gray-700';
                const sidebarMapContainer = mapSidebar.querySelector('.property-detail-card');
                const locationSearch = mapSidebar.querySelector('.location-search');
                sidebarMapContainer.insertBefore(newMapDiv, locationSearch);
                // Move detailed filters back to the sidebar
                if (detailedFilterSection && sidebarDetailCard) {
                    // Append it back to the property-detail-card in the sidebar.
                    // It should go after locationSearch, appendChild places it at the end, which is correct here.
                    sidebarDetailCard.appendChild(detailedFilterSection);
                }
                if (mapSidebar) mapSidebar.style.display = '';
                document.body.classList.remove('drawer-open');
                setTimeout(() => {
                    if (window.portugalMap) {
                        window.portugalMap.remove();
                        window.portugalMap = null;
                    }
                    const props = window.lastLoadedProperties || [];
                    initializePortugalMap(props);
                }, 200);
            }

            toggleMapDrawerBtn.addEventListener('click', () => {
                if (!drawerOpen) {
                    openDrawer();
                } else {
                    closeDrawer();
                }
            });
            // On load, ensure drawer is closed and map/sidebar are in place
            closeDrawer();
        });

        (async () => {
            console.log('[DEBUG] A chamar displayProperties()');
            await displayProperties();
        })();
    </script>
</body>
</html>
