<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile - Estate App</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- Toast Messages -->
    <div id="toast" class="toast"></div>

    <!-- Header with gradient background -->
    <header class="header-gradient text-white pt-6 pb-8 px-6 mb-8 fixed-header">
        <div class="container mx-auto">
            <div class="flex justify-between items-center mb-8">
                <a href="/index.html" class="text-2xl font-bold">DomuState</a>
                <!-- Centralized Navigation Links -->
                <div class="flex-1 flex justify-center">
                    <nav class="relative flex space-x-10">
                        <a href="/index.html" class="nav-link active">Home</a>
                        <a href="/favorites.html" class="nav-link">Favourites</a>
                        <a href="/new_listing.html" class="nav-link">Sell</a>
                        <a href="#" class="nav-link locked-feature" style="pointer-events: none">
                            <span class="flex items-center gap-2 opacity-50">
                                Renovate
                                <i class="fas fa-lock text-sm"></i>
                            </span>
                        </a>
                    </nav>
                </div>
                <!-- User Info - Desktop -->
                <div class="hidden md:flex items-center space-x-4 auth-linkslogout" id="userInfo">
                    <i class="fas fa-user text-white"></i>
                    <a href="/user-profile.html" id="username" class="text-white transition-all duration-150 hover:text-blue-200 hover:-translate-y-0.5"></a>
                    <button id="logoutBtn" class="text-white transition-all duration-150 hover:text-blue-200 hover:-translate-y-0.5">Logout</button>
                </div>
                <!-- Mobile menu button -->
                <button class="md:hidden p-2 rounded-full bg-white bg-opacity-10 hover:bg-opacity-20 transition-all duration-150">
                    <i class="fas fa-bars text-white"></i>
                </button>
            </div>
        </div>
    </header>

    <div class="content-wrapper">
        <div class="container mx-auto px-4 py-8">
            <!-- Page Title -->
            <div class="mb-8">
                <h1 class="text-3xl font-bold mb-2">My Account</h1>
                <p class="text-gray-400">Manage your profile, listings, and account settings</p>
            </div>

            <!-- Main Content -->
            <div class="card p-6">
                <!-- Profile Header -->
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 pb-4 border-b border-gray-700">
                    <div class="flex items-center mb-4 md:mb-0">
                        <div class="w-16 h-16 rounded-full bg-blue-600 flex items-center justify-center text-2xl font-bold" id="userInitials">
                            JD
                        </div>
                        <div class="ml-4">
                            <h2 class="text-xl font-bold" id="profileUsername">John Doe</h2>
                            <p class="text-gray-400" id="profileEmail">john@example.com</p>
                            <div class="mt-1">
                                <span class="badge badge-primary" id="profileRole">Buyer</span>
                                <span class="text-gray-400 text-sm ml-2" id="profileMember">Member since: Jan 2023</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab Navigation -->
                <div class="tab-header">
                    <button class="tab-btn active" data-tab="profile">Profile</button>
                    <button class="tab-btn" data-tab="listings">My Listings</button>
                    <button class="tab-btn" data-tab="security">Security</button>
                </div>

                <!-- Profile Tab -->
                <div id="profileTab" class="tab-content active">
                    <h3 class="text-xl font-semibold mb-4">Personal Information</h3>
                    <form id="profileForm">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="form-group">
                                <label class="label" for="username">Username</label>
                                <input type="text" id="username-field" class="input-field" placeholder="Username">
                            </div>
                            <div class="form-group">
                                <label class="label" for="name">Full Name</label>
                                <input type="text" id="name-field" class="input-field" placeholder="Full Name">
                            </div>
                            <div class="form-group">
                                <label class="label" for="email">Email Address</label>
                                <input type="email" id="email-field" class="input-field" placeholder="Email">
                            </div>
                            <div class="form-group">
                                <label class="label" for="role">Account Type</label>
                                <input type="text" id="role-field" class="input-field" disabled>
                            </div>
                        </div>
                        <div class="mt-6 flex justify-end">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save mr-2"></i> Save Changes
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Listings Tab -->
                <div id="listingsTab" class="tab-content">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-semibold">My Property Listings</h3>
                        <a href="/new_listing.html" class="btn btn-primary">
                            <i class="fas fa-plus mr-2"></i> Add New Listing
                        </a>
                    </div>
                    <div id="listingsContainer" class="space-y-4">
                        <div class="empty-listings hidden text-center py-8">
                            <i class="fas fa-home text-4xl text-gray-600 mb-3"></i>
                            <h4 class="text-xl font-medium text-gray-400">No listings yet</h4>
                            <p class="text-gray-500 mb-4">You haven't published any property listings</p>
                        </div>
                    </div>
                </div>

                <!-- Security Tab -->
                <div id="securityTab" class="tab-content">
                    <h3 class="text-xl font-semibold mb-4">Change Password</h3>
                    <form id="passwordForm">
                        <div class="space-y-4 max-w-md">
                            <div class="form-group">
                                <label class="label" for="currentPassword">Current Password</label>
                                <input type="password" id="currentPassword" class="input-field" placeholder="Enter current password">
                            </div>
                            <div class="form-group">
                                <label class="label" for="newPassword">New Password</label>
                                <input type="password" id="newPassword" class="input-field" placeholder="Enter new password">
                            </div>
                            <div class="form-group">
                                <label class="label" for="confirmPassword">Confirm New Password</label>
                                <input type="password" id="confirmPassword" class="input-field" placeholder="Confirm new password">
                            </div>
                        </div>
                        <div class="mt-6">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-key mr-2"></i> Update Password
                            </button>
                        </div>
                    </form>

                    <div class="divider"></div>

                    <h3 class="text-xl font-semibold mb-4 text-red-500">Danger Zone</h3>
                    <p class="text-gray-400 mb-4">Once you delete your account, there is no going back. Please be certain.</p>
                    <button id="deleteAccountBtn" class="btn btn-danger">
                        <i class="fas fa-trash-alt mr-2"></i> Delete Account
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Account Confirmation Modal -->
    <div id="deleteAccountModal" class="modal-bg">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title text-red-500">Delete Account</h3>
                <button class="close-btn">&times;</button>
            </div>
            <p class="mb-4">This action cannot be undone. This will permanently delete your account and remove all your data from our servers.</p>
            <p class="mb-6">Please enter your password to confirm:</p>
            <div class="form-group">
                <input type="password" id="deleteAccountPassword" class="input-field" placeholder="Enter your password">
            </div>
            <div class="flex space-x-3 justify-end">
                <button class="btn btn-secondary modal-cancel">Cancel</button>
                <button id="confirmDeleteAccount" class="btn btn-danger">Delete My Account</button>
            </div>
        </div>
    </div>

    <!-- Delete Listing Confirmation Modal -->
    <div id="deleteListingModal" class="modal-bg">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title text-red-500">Delete Listing</h3>
                <button class="close-btn">&times;</button>
            </div>
            <p class="mb-6">Are you sure you want to delete this listing? This action cannot be undone.</p>
            <div class="flex space-x-3 justify-end">
                <button class="btn btn-secondary modal-cancel">Cancel</button>
                <button id="confirmDeleteListing" class="btn btn-danger" data-listing-id="">Delete Listing</button>
            </div>
        </div>
    </div>

    <script>
        // DOM elements
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        const profileForm = document.getElementById('profileForm');
        const passwordForm = document.getElementById('passwordForm');
        const deleteAccountBtn = document.getElementById('deleteAccountBtn');
        const deleteAccountModal = document.getElementById('deleteAccountModal');
        const deleteListingModal = document.getElementById('deleteListingModal');
        const closeButtons = document.querySelectorAll('.close-btn, .modal-cancel');
        const confirmDeleteAccount = document.getElementById('confirmDeleteAccount');
        const confirmDeleteListing = document.getElementById('confirmDeleteListing');
        const toast = document.getElementById('toast');
        const logoutBtn = document.getElementById('logoutBtn');
        const apiBaseUrl = 'http://localhost:8800/api';
        
        let currentUser = null;
        let userListings = [];

        // Tab navigation functionality
        console.log('[DEBUG] tabButtons:', tabButtons);
        console.log('[DEBUG] tabContents:', tabContents);

        function activateTab(tabId) {
            console.log('[DEBUG] Activating tab:', tabId);
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            document.querySelector(`.tab-btn[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(`${tabId}Tab`).classList.add('active');
            // Debug: log which tab is now active
            tabContents.forEach(content => {
                console.log('[DEBUG] Tab', content.id, 'active:', content.classList.contains('active'));
            });
        }

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const tabId = button.getAttribute('data-tab');
                console.log('[DEBUG] Tab button clicked:', tabId);
                activateTab(tabId);
            });
        });

        // Ao carregar a página, ativa só a tab profile
        activateTab('profile');

        // Close modals
        closeButtons.forEach(button => {
            button.addEventListener('click', () => {
                deleteAccountModal.classList.remove('active');
                deleteListingModal.classList.remove('active');
            });
        });

        // Open delete account modal
        deleteAccountBtn.addEventListener('click', () => {
            deleteAccountModal.classList.add('active');
        });

        // Show toast message
        function showToast(message, type = 'success') {
            toast.textContent = message;
            toast.className = `toast show toast-${type}`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Get authentication token from localStorage
        function getToken() {
            return localStorage.getItem('token');
        }

        // Redirect to login if not authenticated
        function checkAuth() {
            const token = getToken();
            if (!token) {
                window.location.href = '/login.html';
            }
            return token;
        }

        // Load user profile data
        async function loadUserProfile() {
            try {
                const token = checkAuth();
                const response = await fetch(`${apiBaseUrl}/users/profile`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load profile');
                }
                
                currentUser = await response.json();
                
                // Update profile header
                document.getElementById('username').textContent = currentUser.username;
                document.getElementById('profileUsername').textContent = currentUser.username;
                document.getElementById('profileEmail').textContent = currentUser.email;
                document.getElementById('profileRole').textContent = currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1);
                document.getElementById('profileMember').textContent = `Member since: ${new Date(currentUser.createdAt).toLocaleDateString()}`;
                
                // Set user initials
                const initials = currentUser.name 
                    ? `${currentUser.name.split(' ')[0][0]}${currentUser.name.split(' ')[1] ? currentUser.name.split(' ')[1][0] : ''}`
                    : currentUser.username.substring(0, 2).toUpperCase();
                document.getElementById('userInitials').textContent = initials;
                
                // Fill profile form
                document.getElementById('username-field').value = currentUser.username;
                document.getElementById('name-field').value = currentUser.name || '';
                document.getElementById('email-field').value = currentUser.email;
                document.getElementById('role-field').value = currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1);
                
                // Load user listings
                userListings = currentUser.posts;
                renderListings();
                
            } catch (error) {
                console.error('Error loading user profile:', error);
                showToast('Failed to load user profile', 'error');
            }
        }

        // Render user listings
        function renderListings() {
            const listingsContainer = document.getElementById('listingsContainer');
            const emptyListings = document.querySelector('.empty-listings');
            
            // Clear existing listings
            listingsContainer.innerHTML = '';
            
            if (userListings.length === 0) {
                emptyListings.classList.remove('hidden');
                listingsContainer.appendChild(emptyListings);
                return;
            }
            function getProperImageUrl(imageUrl) {
                if (!imageUrl) return 'https://via.placeholder.com/300x200/1e293b/ffffff?text=No+Image';
                if (imageUrl.startsWith('http://') || imageUrl.startsWith('https://')) return imageUrl;
                if (imageUrl.startsWith('/uploads/')) return `http://localhost:8800/api${imageUrl}`;
                return `http://localhost:8800/api/uploads/listings/${imageUrl}`;
            }

            emptyListings.classList.add('hidden');
            
            // Render each listing
            userListings.forEach(listing => {
                const listingCard = document.createElement('div');
                listingCard.className = 'property-card';
                
                // Use the first image or a placeholder
                const imageUrl = listing.images && listing.images.length > 0 
                    ? getProperImageUrl(listing.images[0])
                    : 'https://via.placeholder.com/150x100';
                    console.log('Imagem original:', listing.images[0], 'Imagem final:', imageUrl);
                
                listingCard.innerHTML = `
                    <img src="${imageUrl}" alt="${listing.title}" class="property-image">
                    <div class="flex-1 p-4">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-bold text-lg">${listing.title}</h4>
                                <p class="text-gray-400 text-sm">${listing.address}, ${listing.city}</p>
                                <div class="mt-2 flex space-x-3">
                                    <span class="text-sm text-gray-400"><i class="fas fa-bed mr-1"></i> ${listing.bedroom}</span>
                                    <span class="text-sm text-gray-400"><i class="fas fa-bath mr-1"></i> ${listing.bathroom}</span>
                                    <span class="text-sm text-gray-400"><i class="fas fa-ruler-combined mr-1"></i> ${listing.area} m²</span>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-blue-500 font-bold">€${listing.price.toLocaleString()}</div>
                                <div class="text-gray-500 text-xs">${new Date(listing.createdAt).toLocaleDateString()}</div>
                            </div>
                        </div>
                        <div class="flex justify-end mt-4 space-x-2">
                            <a href="/property.html?id=${listing.id}" class="btn btn-secondary btn-sm">
                                <i class="fas fa-eye mr-1"></i> View
                            </a>
                            <a href="/edit_listing.html?id=${listing.id}" class="btn btn-primary btn-sm edit-listing" data-id="${listing.id}">
                                <i class="fas fa-edit mr-1"></i> Edit
                            </a>
                            <button class="btn btn-danger btn-sm delete-listing" data-id="${listing.id}">
                                <i class="fas fa-trash-alt mr-1"></i> Delete
                            </button>
                        </div>
                    </div>
                `;
                
                listingsContainer.appendChild(listingCard);
                
                // Add event listeners to the new buttons
                const deleteBtn = listingCard.querySelector('.delete-listing');
                deleteBtn.addEventListener('click', () => {
                    openDeleteListingModal(listing.id);
                });
            });
        }

        // Open delete listing modal
        function openDeleteListingModal(listingId) {
            confirmDeleteListing.setAttribute('data-listing-id', listingId);
            deleteListingModal.classList.add('active');
        }

        // Update user profile
        profileForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('username-field').value;
            const name = document.getElementById('name-field').value;
            const email = document.getElementById('email-field').value;
            
            try {
                const token = checkAuth();
                const response = await fetch(`${apiBaseUrl}/users/profile`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, name, email })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to update profile');
                }
                
                const data = await response.json();
                
                // Update current user data
                currentUser = { ...currentUser, ...data.user };
                
                // Update UI
                document.getElementById('username').textContent = currentUser.username;
                document.getElementById('profileUsername').textContent = currentUser.username;
                document.getElementById('profileEmail').textContent = currentUser.email;
                
                showToast('Profile updated successfully');
                
            } catch (error) {
                console.error('Error updating profile:', error);
                showToast(error.message || 'Failed to update profile', 'error');
            }
        });

        // Update password
        passwordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (newPassword !== confirmPassword) {
                showToast('Passwords do not match', 'error');
                return;
            }
            
            try {
                const token = checkAuth();
                const response = await fetch(`${apiBaseUrl}/users/profile`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ currentPassword, newPassword })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to update password');
                }
                
                // Clear password fields
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';
                
                showToast('Password updated successfully');
                
            } catch (error) {
                console.error('Error updating password:', error);
                showToast(error.message || 'Failed to update password', 'error');
            }
        });

        // Delete account
        confirmDeleteAccount.addEventListener('click', async () => {
            const password = document.getElementById('deleteAccountPassword').value;
            
            if (!password) {
                showToast('Please enter your password', 'error');
                return;
            }
            
            try {
                const token = checkAuth();
                const response = await fetch(`${apiBaseUrl}/users`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ password })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to delete account');
                }
                
                // Clear local storage and redirect to home
                localStorage.removeItem('token');
                window.location.href = '/index.html';
                
            } catch (error) {
                console.error('Error deleting account:', error);
                showToast(error.message || 'Failed to delete account', 'error');
            }
        });

        // Delete listing
        confirmDeleteListing.addEventListener('click', async () => {
            const listingId = confirmDeleteListing.getAttribute('data-listing-id');
            
            try {
                const token = checkAuth();
                const response = await fetch(`${apiBaseUrl}/users/posts/${listingId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to delete listing');
                }
                
                // Remove deleted listing from array
                userListings = userListings.filter(listing => listing.id !== listingId);
                
                // Update UI
                renderListings();
                deleteListingModal.classList.remove('active');
                
                showToast('Listing deleted successfully');
                
            } catch (error) {
                console.error('Error deleting listing:', error);
                showToast(error.message || 'Failed to delete listing', 'error');
                deleteListingModal.classList.remove('active');
            }
        });

        // Logout functionality
        logoutBtn.addEventListener('click', async () => {
            try {
                const token = getToken();
                
                if (token) {
                    // Call logout endpoint
                    await fetch(`${apiBaseUrl}/auth/logout`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                }
                
                // Clear token and redirect to home
                localStorage.removeItem('token');
                window.location.href = '/index.html';
                
            } catch (error) {
                console.error('Error during logout:', error);
                // Even if there's an error, clear token and redirect
                localStorage.removeItem('token');
                window.location.href = '/index.html';
            }
        });

        // Load user data on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadUserProfile();
        });
    </script>
</body>
</html>